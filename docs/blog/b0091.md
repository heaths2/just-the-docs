---
layout: default
title: Ansible AWX 설치 매뉴얼
parent: Blog
grand_parent: Category
permalink: docs/category/blog/b0091
child_nav_order: desc
---

# Ansible AWX 설치 매뉴얼
<details open markdown="block">
  <summary>
    Table of contents
  </summary>
  {: .no_toc .text-delta .label .label-green }
1. TOC
{:toc}
</details>

---

## 개요

**Ansible AWX 설치 매뉴얼**
AWX는 Ansible Tower의 오픈소스 버전으로, IT 인프라 관리 및 자동화 작업을 간소화하고 직관적으로 수행할 수 있도록 도와주는 강력한 도구입니다. 본 매뉴얼에서는 다양한 Kubernetes 배포 방식을 활용하여 Ansible AWX를 설치하고 구성하는 과정을 다룹니다.

---

### 1. 목적

이 매뉴얼은 다양한 Kubernetes 배포 방식을 활용하여 Ansible AWX를 설치하고 구성하는 과정을 제공합니다. 사용자는 매뉴얼을 통해 효율적인 방법을 선택하여 자신의 클러스터 환경에 적합한 Ansible AWX 설치를 완료할 수 있습니다.

---

### 2. 설치 방식

다음 4가지 방법으로 AWX를 설치할 수 있습니다:

1. **Minikube**: 로컬 테스트용 경량 Kubernetes 환경.
2. **Kustomize**: YAML 기반의 커스터마이징된 설치.
3. **Helm**: 운영 환경에 적합한 패키지 방식.
4. **Kubespray**: 고가용성 Kubernetes 클러스터 구축 및 AWX 배포.

---

## 3. 구성 요소

- **AWX Operator**: AWX 설치와 관리를 담당.
- **Kubernetes 클러스터**: AWX를 배포하기 위한 필수 환경.
- **Helm Charts / Kustomize**: 설치 자동화를 위한 도구.

---

## 4. 설치 절차 (Kustomize 기준)

#### **4.1 K3s 설치**
간단한 Kubernetes 클러스터 환경을 구축하기 위해 K3s를 설치합니다.

```bash
curl -sfL https://get.k3s.io | sh -
```

#### **4.2 Kustomize 설치**
Kustomize는 Kubernetes 리소스를 관리하기 위한 도구입니다. 다음 명령어로 Kustomize를 설치합니다.

```bash
curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
sudo mv -v ./kustomize /usr/local/bin/
which kustomize
```

#### **4.3 Kustomization 파일 생성**
Kustomize를 위한 디렉터리와 기본 설정 파일을 생성합니다.

##### 4.3.1 디렉터리 생성

```bash
mkdir -pv ~/awx
```

##### 4.3.2 최신 AWX Operator 태그 가져오기

```bash
LTS_TAG=$(curl -s https://api.github.com/repos/ansible/awx-operator/releases/latest | grep tag_name | cut -d '"' -f 4)
```

##### 4.3.3 `kustomization.yaml` 파일 생성

```bash
tee ~/awx/kustomization.yaml << EOF
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  # Find the latest tag here: https://github.com/ansible/awx-operator/releases
  - github.com/ansible/awx-operator/config/default?ref=$LTS_TAG

# Set the image tags to match the git version from above
images:
  - name: quay.io/ansible/awx-operator
    newTag: $LTS_TAG
# Specify a custom namespace in which to install AWX
namespace: awx
EOF
```

##### 4.3.4 Kustomization 파일 적용

```bash
kubectl apply -k ~/awx
```

#### **4.4 AWX 서버 생성**

##### 4.4.1 AWX 서버 리소스 정의 파일 생성

```bash
tee ~/awx/awx-server.yaml << EOF
---
apiVersion: awx.ansible.com/v1beta1
kind: AWX
metadata:
  name: awx-server
spec:
  service_type: nodeport
EOF
```

##### 4.4.2 Kustomization 파일에 리소스 추가

```bash
sed -i '6a\  - awx-server.yaml' ~/awx/kustomization.yaml
```

##### 4.4.3 Kustomization 파일 다시 적용

```bash
kubectl apply -k ~/awx
```

#### **4.5 NodePort 변경**

##### 4.5.1 Service 파일 추출

```bash
kubectl get svc awx-server-service -o yaml > awx-server-service.yaml
```

##### 4.5.2 NodePort 수정

```bash
sed -i '/nodePort:/s/[0-9]\+/32000/' awx-server-service.yaml
```

##### 4.5.3 변경된 파일 유효성 검사

```bash
kubectl apply --dry-run=client -f awx-server-service.yaml
```

##### 4.5.4 변경된 파일 적용

```bash
kubectl apply -f awx-server-service.yaml
```

#### **4.6 서비스 확인 및 AWX UI 접속**

##### 4.6.1 서비스 확인

```bash
kubectl get svc -n awx
```

##### 4.6.2 NodePort 확인 및 접속

- NodePort(예: 32000)를 통해 브라우저에서 AWX Web UI에 접속

```bash
http://<노드IP>:32000
```

##### 4.6.3 AWX Web UI 로그인

```bash
kubectl get secret -n awx awx-server-postgres-configuration -o jsonpath='{.data.postgres-password}' | base64 -d
```



## minikube 방식

### Docker 설치

> - 기존에 설치된 docker 패키지 삭제
>
```bash
for pkg in docker.io docker-doc docker-compose podman-docker containerd runc; do sudo apt-get remove $pkg; done
```
>
{: .important }

- 도커의 공식 GPG 키 추가

```bash
sudo apt-get update
sudo apt-get install ca-certificates curl gnupg
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg
```

- Apt 소스에 저장소 추가

```bash
echo \
  "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update
```

- 도커 Latest 패키지 설치

```bash
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

- 별도 계정 생성시

```bash
# aws 계정 생성
useradd -m awx -d /home/awx -p `openssl passwd 1234` -s /bin/bash -c awx
```

- # sudoers 계정 추가

```bash
vi /etc/sudoers
awx     ALL=(ALL:ALL) ALL
```

- 사용자 전환

```bash
su - awx
```

- docker group 생성

```bash
sudo groupadd docker
```

- 사용자를 도커 그룹에 추가

```bash
sudo usermod -aG docker $USER
```

- 사용자를 docker 그룹에 추가하고 그룹 변경을 현재 세션에서 활성화

```bash
newgrp docker
```

- sudo 없이 도커 명령을 실행할 수 있는지 확인

```bash
docker run hello-world
```

> - 권한 거부시 소유권 변경
```bash
sudo chown "$USER":"$USER" /home/"$USER"/.docker -R
sudo chmod g+rwx "$HOME/.docker" -R
```
>
{: .important }

- 실행 및 종료된 모든 컨테이너 목록 확인

```bash
docker ps -a
```

<details markdown="block">
  <summary>
    결과
  </summary>
  {: .text-delta .label .label-green }
```bash
CONTAINER ID   IMAGE         COMMAND    CREATED          STATUS                      PORTS     NAMES
3410d6ee0c08   hello-world   "/hello"   16 minutes ago   Exited (0) 16 minutes ago             sweet_moser
```
</details>

- Docker 컨테이너 삭제

```bash
docker rm 3410d6ee0c08
```

-  Docker 이미지 삭제

```bash
docker rmi hello-world:latest
```

- Docker 이미지 목록 표시

```bash
docker images
```

### Minikube 설치

- minikube latest 버전 설치

```bash
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube_latest_amd64.deb
sudo dpkg -i minikube_latest_amd64.deb
minikube version
rm minikube_latest_amd64.deb
```

> - `alias` 등록
```bash
alias kubectl="minikube kubectl --"
```
>
{: .highlight }

> `root` 계정으로 minikube cluster 생성
```bash
minikube start --cpus=4 --memory=6G --addons=ingress --force
```
>
{: .highlight }

- `awx` 계정으로 minikube cluster 생성

```bash
minikube start --cpus=4 --memory=6G --addons=ingress
```

- Kubernetes Dashboard 실행

```bash
minikube dashboard
```

- Kubernetes 클러스터에 Kustomize 설정 빌드

```bash
cd ~/.awx && kubectl apply -k .
```

---

### kustomize & minikube 동일 명령어

- Kubernetes 컨텍스트의 네임스페이스 변경

```bash
kubectl config set-context --current --namespace=awx
```

- AWX Pod Running 확인 

```bash
watch -d -n 1 'minikube kubectl -- get pods -n awx'
```

```bash
watch -d -n 1 'kubectl get pods -n awx'
```

- Kubernetes 클러스터에서 `awx` 네임스페이스 내의 파드 목록을 조회

```bash
kubectl get pods --namespace awx
```

<details markdown="block">
  <summary>
    결과
  </summary>
  {: .text-delta .label .label-green }

```bash
NAME                                               READY   STATUS    RESTARTS   AGE
awx-operator-controller-manager-65ddfcbf7d-pp8np   2/2     Running   0          22m
awx-server-postgres-13-0                           1/1     Running   0          5m4s
awx-server-task-5bc54bcc55-9rmtm                   4/4     Running   0          3m59s
awx-server-web-6795b4f6cf-7k9bc                    3/3     Running   0          117s
```
</details>

- `admin` 계정 암호화된 비밀번호 확인

```bash
kubectl get secret awx-server-admin-password -o jsonpath="{.data.password}" | base64 --decode ; echo
```

- 컨테이너 로그 확인

```bash
kubectl logs -f deployments/awx-operator-controller-manager -c awx-manager -n awx
```

- 외부 통신 Port Forwarding

```
kubectl port-forward service/awx-server-service --address 0.0.0.0 30080:80
```

- AWX 서버 `admin` 계정 패스워드 변경

```bash
kubectl exec -it awx-server-web-6795b4f6cf-7k9bc -n awx -- awx-manage changepassword admin
```

<details markdown="block">
  <summary>
    결과
  </summary>
  {: .text-delta .label .label-green }
 
```bash
Changing password for user 'admin'
Password:
Password (again):
Password changed successfully for user 'admin'
```
</details>

---
## AWX postgresql dump 방법

- PostgreSQL 데이터베이스에서 덤프 생성

```bash
kubectl exec -it awx-server-postgres-13-0 -- pg_dump -U awx -w -Fp -b -v -f /tmp/awx.sql -d awx
```

- 로컬로 덤프 파일 복사

```bash
kubectl cp -a awx/awx-server-postgres-13-0:tmp/awx.sql ~/awx.sql
```

---
## 기타 명령어

```bash
kubectl get nodes
kubectl get pods
kubectl get svc
kubectl get pods -l "app.kubernetes.io/managed-by=awx-operator"
kubectl get svc -l "app.kubernetes.io/managed-by=awx-operator"
```

```bash
minikube service awx-server-service -n awx --url
minikube service awx-server-service -n awx
```

### 참고

- [AWX 공식 문서](https://ansible.readthedocs.io/projects/awx-operator/en/latest/)
- [AWX Operator 공식 리포지토리](https://github.com/ansible/awx-operator)
- [K3s 공식 문서](https://github.com/k3s-io/k3s)
- [Kustomize 공식 문서](https://kubectl.docs.kubernetes.io/installation/kustomize/binaries/)
- [Docker 공식 문서](https://docs.docker.com/engine/install/ubuntu/)
- [Docker 공식 문서<권한>](https://docs.docker.com/engine/install/linux-postinstall/)
- [Minikube 공식 문서](https://minikube.sigs.k8s.io/docs/start/)
- [Kubespray 공식 리포지토리](https://github.com/kubernetes-sigs/kubespray)
- [Helm 공식 문서](https://helm.sh/docs/intro/install/)
- [AWX Operator Helm Chart 공식 문서](https://ansible-community.github.io/awx-operator-helm/)
- [AWX Operator 공식 문서](https://ansible.readthedocs.io/projects/awx-operator/en/latest/)
- [유튜브 참조](https://youtu.be/n3SzwzbxfRE)
