---
layout: default
title: Ansible AWX 설치 매뉴얼
parent: Blog
grand_parent: Category
permalink: docs/category/blog/b0091
child_nav_order: desc
---

# Ansible AWX 설치 매뉴얼
<details open markdown="block">
  <summary>
    Table of contents
  </summary>
  {: .no_toc .text-delta .label .label-green }
1. TOC
{:toc}
</details>
---

## 개요

**Ansible AWX 설치 매뉴얼**
AWX는 Ansible Tower의 오픈소스 버전으로, IT 인프라 관리 및 자동화 작업을 간소화하고 직관적으로 수행할 수 있도록 도와주는 강력한 도구입니다. 본 매뉴얼에서는 다양한 Kubernetes 배포 방식을 활용하여 Ansible AWX를 설치하고 구성하는 과정을 다룹니다.

---

### 1. 목적

이 매뉴얼은 다양한 Kubernetes 배포 방식을 활용하여 Ansible AWX를 설치하고 구성하는 과정을 제공합니다. 사용자는 매뉴얼을 통해 효율적인 방법을 선택하여 자신의 클러스터 환경에 적합한 Ansible AWX 설치를 완료할 수 있습니다.

---

### 2. 설치 방식

이 블로그에서는 Ansible AWX를 설치하기 위한 다음 네 가지 방법을 다룹니다:

#### 2.1 Minikube 방식
- Minikube는 로컬 Kubernetes 환경을 설정하는 데 사용됩니다.
- 학습 및 테스트 목적으로 사용하기 적합합니다.
- AWX Operator를 Minikube 클러스터에 설치하는 과정을 안내합니다.

#### 2.2 Kustomize 방식
- Kustomize는 Kubernetes 리소스 관리를 위한 도구로, 구성 파일을 오버레이하고 수정하기에 적합합니다.
- 커스터마이징된 설정을 사용하여 AWX Operator와 AWX를 설치하는 방법을 제공합니다.

#### 2.3 Helm 방식
- Helm은 Kubernetes 애플리케이션을 패키징하고 관리하기 위한 도구입니다.
- AWX Operator와 AWX를 간단하고 효율적으로 설치할 수 있습니다.
- 운영 환경에서 AWX를 설치 및 관리하는 데 적합합니다.

#### 2.4 Kubespray 방식
- Kubespray는 Ansible Playbook 기반으로 다중 노드 Kubernetes 클러스터를 구축하고 관리하는 데 적합한 도구입니다.
- Kubernetes 클러스터를 처음부터 구성하고 AWX를 배포하는 데 유용합니다.
- 고가용성(HA) 환경에서도 안정적인 Kubernetes 클러스터와 AWX를 제공할 수 있습니다.

---

### 3. 구성 요소

각 방식에서는 다음 구성 요소를 설정하고 활용합니다:

- **AWX Operator**: AWX를 설치 및 관리하는 Kubernetes Custom Resource Operator.
- **Kubernetes 클러스터**: AWX를 배포하기 위한 기반 인프라.
- **Helm Charts**: AWX Operator와 AWX 설치를 위한 Helm 패키지.
- **Kubespray**: Kubernetes 클러스터 구성 및 관리.
- **AWX Web UI**: Ansible 작업을 시각적으로 관리하는 데 사용.

---

### 4. 내용 구성

이 매뉴얼은 다음과 같은 흐름으로 구성됩니다:

#### 4.1 필수 구성 요소 준비
- Kubernetes 클러스터 준비:
  - Minikube 및 Helm 방식: 기존 클러스터 활용.
  - Kubespray 방식: 클러스터 구축.
- Helm 및 Kustomize 설치 및 설정.
- Kubespray 설치 및 Ansible Playbook 구성.

#### 4.2 설치 방법 상세
- Minikube 환경에서 AWX 설치.
- Kustomize를 활용한 구성 파일 기반 설치.
- Helm을 사용한 AWX Operator 및 AWX 설치.
- Kubespray를 사용하여 다중 노드 Kubernetes 클러스터 및 AWX 설치.

#### 4.3 테스트 및 검증
- AWX Web UI 접속 및 기본 설정 확인.
- 간단한 Ansible Playbook 실행 테스트.

#### 4.4 트러블슈팅
- 설치 중 발생할 수 있는 일반적인 오류와 해결 방법.

---

### 다음 단계

각 설치 방법에 대한 상세한 내용은 이어지는 섹션에서 설명합니다. 적합한 방법을 선택하여 진행해 보세요!


{: .note }
> - [AWX Documents](https://ansible.readthedocs.io/projects/awx-operator/en/latest/)
> - [AWX Operator Git](https://github.com/ansible/awx-operator)
> - [docker 설치](https://docs.docker.com/engine/install/ubuntu/)
> - [docker 권한](https://docs.docker.com/engine/install/linux-postinstall/)
> - [Minikube 설치](https://minikube.sigs.k8s.io/docs/start/)
> - [tag 정보](https://github.com/ansible/awx-operator/tags)
> - [k3s](https://github.com/k3s-io/k3s)
> - [kustomize](https://kubectl.docs.kubernetes.io/installation/kustomize/binaries/)
> - [유튜브 참조](https://youtu.be/n3SzwzbxfRE)
> - [helm.md](https://github.com/ansible/awx-operator/blob/devel/docs/installation/helm-install-on-existing-cluster.md)
> - [Helm](https://www.linuxtechi.com/install-use-helm-in-kubernetes/)

---

## Ansible 설치

```bash
sudo apt update
sudo apt install software-properties-common
sudo add-apt-repository --yes --update ppa:ansible/ansible
sudo apt install ansible
```

## YAML 설정 파일

- 디렉토리 생성

```bash
mkdir -p ~/.awx
```

```bash
# Basic Install
LTS_TAG=`curl -s https://api.github.com/repos/ansible/awx-operator/releases/latest | grep tag_name | cut -d '"' -f 4`

tee ~/.awx/kustomization.yaml << EOF
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  # Find the latest tag here: https://github.com/ansible/awx-operator/releases
  - github.com/ansible/awx-operator/config/default?ref=$LTS_TAG
  - awx-server.yaml
# Set the image tags to match the git version from above
images:
  - name: quay.io/ansible/awx-operator
    newTag: $LTS_TAG
# Specify a custom namespace in which to install AWX
namespace: awx
EOF

```

```bash
tee ~/.awx/awx-server.yaml << EOF
---
apiVersion: awx.ansible.com/v1beta1
kind: AWX
metadata:
  name: awx-server
spec:
  service_type: nodeport
  nodeport_port: 30080
EOF

```

## kustomize 방식

- 경량 Kubernetes 설치

```bash
curl -sfL https://get.k3s.io | sh -
```

- 미리 컴파일된 Binaries 파일을 다운로드 및 Kustomize 설치

```bash
curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
```

```bash
sudo mv kustomize /usr/local/bin/
which kustomize
```

<details markdown="block">
  <summary>
    결과
  </summary>
  {: .text-delta .label .label-green }
  
```bash
/usr/local/bin/kustomize
```
</details>

- Kubernetes 클러스터에 Kustomize 설정 빌드 

```bash
cd ~/.awx && kustomize build . | kubectl apply -f -
```

---
## minikube 방식

### Docker 설치

> - 기존에 설치된 docker 패키지 삭제
>
```bash
for pkg in docker.io docker-doc docker-compose podman-docker containerd runc; do sudo apt-get remove $pkg; done
```
>
{: .important }

- 도커의 공식 GPG 키 추가

```bash
sudo apt-get update
sudo apt-get install ca-certificates curl gnupg
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg
```

- Apt 소스에 저장소 추가

```bash
echo \
  "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update
```

- 도커 Latest 패키지 설치

```bash
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

- 별도 계정 생성시

```bash
# aws 계정 생성
useradd -m awx -d /home/awx -p `openssl passwd 1234` -s /bin/bash -c awx
```

- # sudoers 계정 추가

```bash
vi /etc/sudoers
awx     ALL=(ALL:ALL) ALL
```

- 사용자 전환

```bash
su - awx
```

- docker group 생성

```bash
sudo groupadd docker
```

- 사용자를 도커 그룹에 추가

```bash
sudo usermod -aG docker $USER
```

- 사용자를 docker 그룹에 추가하고 그룹 변경을 현재 세션에서 활성화

```bash
newgrp docker
```

- sudo 없이 도커 명령을 실행할 수 있는지 확인

```bash
docker run hello-world
```

> - 권한 거부시 소유권 변경
```bash
sudo chown "$USER":"$USER" /home/"$USER"/.docker -R
sudo chmod g+rwx "$HOME/.docker" -R
```
>
{: .important }

- 실행 및 종료된 모든 컨테이너 목록 확인

```bash
docker ps -a
```

<details markdown="block">
  <summary>
    결과
  </summary>
  {: .text-delta .label .label-green }
```bash
CONTAINER ID   IMAGE         COMMAND    CREATED          STATUS                      PORTS     NAMES
3410d6ee0c08   hello-world   "/hello"   16 minutes ago   Exited (0) 16 minutes ago             sweet_moser
```
</details>

- Docker 컨테이너 삭제

```bash
docker rm 3410d6ee0c08
```

-  Docker 이미지 삭제

```bash
docker rmi hello-world:latest
```

- Docker 이미지 목록 표시

```bash
docker images
```

### Minikube 설치

- minikube latest 버전 설치

```bash
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube_latest_amd64.deb
sudo dpkg -i minikube_latest_amd64.deb
minikube version
rm minikube_latest_amd64.deb
```

> - `alias` 등록
```bash
alias kubectl="minikube kubectl --"
```
>
{: .highlight }

> `root` 계정으로 minikube cluster 생성
```bash
minikube start --cpus=4 --memory=6G --addons=ingress --force
```
>
{: .highlight }

- `awx` 계정으로 minikube cluster 생성

```bash
minikube start --cpus=4 --memory=6G --addons=ingress
```

- Kubernetes Dashboard 실행

```bash
minikube dashboard
```

- Kubernetes 클러스터에 Kustomize 설정 빌드

```bash
cd ~/.awx && kubectl apply -k .
```

---

### kustomize & minikube 동일 명령어

- Kubernetes 컨텍스트의 네임스페이스 변경

```bash
kubectl config set-context --current --namespace=awx
```

- AWX Pod Running 확인 

```bash
watch -d -n 1 'minikube kubectl -- get pods -n awx'
```

```bash
watch -d -n 1 'kubectl get pods -n awx'
```

- Kubernetes 클러스터에서 `awx` 네임스페이스 내의 파드 목록을 조회

```bash
kubectl get pods --namespace awx
```

<details markdown="block">
  <summary>
    결과
  </summary>
  {: .text-delta .label .label-green }

```bash
NAME                                               READY   STATUS    RESTARTS   AGE
awx-operator-controller-manager-65ddfcbf7d-pp8np   2/2     Running   0          22m
awx-server-postgres-13-0                           1/1     Running   0          5m4s
awx-server-task-5bc54bcc55-9rmtm                   4/4     Running   0          3m59s
awx-server-web-6795b4f6cf-7k9bc                    3/3     Running   0          117s
```
</details>

- `admin` 계정 암호화된 비밀번호 확인

```bash
kubectl get secret awx-server-admin-password -o jsonpath="{.data.password}" | base64 --decode ; echo
```

- 컨테이너 로그 확인

```bash
kubectl logs -f deployments/awx-operator-controller-manager -c awx-manager -n awx
```

- 외부 통신 Port Forwarding

```
kubectl port-forward service/awx-server-service --address 0.0.0.0 30080:80
```

- AWX 서버 `admin` 계정 패스워드 변경

```bash
kubectl exec -it awx-server-web-6795b4f6cf-7k9bc -n awx -- awx-manage changepassword admin
```

<details markdown="block">
  <summary>
    결과
  </summary>
  {: .text-delta .label .label-green }
 
```bash
Changing password for user 'admin'
Password:
Password (again):
Password changed successfully for user 'admin'
```
</details>

---
## AWX postgresql dump 방법

- PostgreSQL 데이터베이스에서 덤프 생성

```bash
kubectl exec -it awx-server-postgres-13-0 -- pg_dump -U awx -w -Fp -b -v -f /tmp/awx.sql -d awx
```

- 로컬로 덤프 파일 복사

```bash
kubectl cp -a awx/awx-server-postgres-13-0:tmp/awx.sql ~/awx.sql
```

---
## 기타 명령어

```bash
kubectl get nodes
kubectl get pods
kubectl get svc
kubectl get pods -l "app.kubernetes.io/managed-by=awx-operator"
kubectl get svc -l "app.kubernetes.io/managed-by=awx-operator"
```

```bash
minikube service awx-server-service -n awx --url
minikube service awx-server-service -n awx
```
