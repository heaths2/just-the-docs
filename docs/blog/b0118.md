---
layout: default
title: Routing Tables 설정
parent: Blog
grand_parent: Category
permalink: docs/category/blog/b0118
child_nav_order: desc
---
# Routing Tables설정
<details open markdown="block">
  <summary>
    Table of contents
  </summary>
  {: .no_toc .text-delta .label .label-green }
1. TOC
{:toc}
</details>
---

## 개요

> - Routing Tables설정
> - [IP Routing](http://linux-ip.net/html/routing-tables.html)
> - [iproute2 ](https://tldp.org/HOWTO/Adv-Routing-HOWTO/lartc.rpdb.html)
> - [](https://blog.scottlowe.org/2013/05/29/a-quick-introduction-to-linux-policy-routing/)
{: .new }

### Routing Tables 설정

>
| 구분         | Source IP           | Destination IP     |
|:-----------:|:-------------------:|:------------------:|
| from         | all                 | 166.166.166.211    |
| to           | 166.166.166.211     | all                |
>
{: .important }


- 네트워크 설정 정의 YAML 파일 작성 `영구`

```bash
/etc/netplan/00-installer-config.yaml
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .label .label-green }
  
```bash
# This is the network config written by 'subiquity'
network:
  version: 2
  renderer: networkd
  ethernets:
    enp0s3:
      dhcp4: false
      optional: true
      dhcp6: false
      optional: true
      addresses: [ 192.168.0.35/24 ]
      gateway4: 192.168.0.1
      nameservers:
        addresses: [ 164.124.101.2, 210.220.163.82, 1.1.1.1, 8.8.8.8 ]
      routes:
        - to: 0.0.0.0/0
          via: 192.168.0.1
          metric: 100
          table: 101
      routing-policy:
        - from: 192.168.0.0/24
          table: 101
        - to: 192.168.0.1/24
          table: 101
    enp0s8:
      dhcp4: false
      dhcp6: false
      optional: true
      addresses: [ 172.16.0.6/24 ]
      gateway4: 172.16.0.1
      nameservers:
        addresses: [ 164.124.101.2, 210.220.163.82, 1.1.1.1, 8.8.8.8 ]
```

</details>

- 네트워크 설정 정의 `임시`

```bash
sudo ip route add default via 192.168.0.1 table rt2
sudo ip route add 192.168.0.0/24 dev eth1 src 192.168.0.35 table rt2
sudo ip rule add from 192.168.0.35/32 table rt2
sudo ip rule add to 192.168.0.35/32 table rt2
```

- 네트워크 설정 적용

```bash
netplan apply
```

- 네트워크 서비스 재시작

```bash
systemctl restart systemd-networkd.service
```

- 네트워크 라우팅 정책 및 규칙 정보

```bash
ip rule show
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .label .label-green }

```bash
0:      from all lookup local
0:      from 192.168.0.0/24 lookup 101
32766:  from all lookup main
32767:  from all lookup default
```

</details>

- 라우팅 테이블 `netstat`

```bash
netstat --route --numeric
# 또는
netstat -rn
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .label .label-green }

```bash
Kernel IP routing table
Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
0.0.0.0         172.16.0.1      0.0.0.0         UG        0 0          0 enp0s8
0.0.0.0         192.168.0.1     0.0.0.0         UG        0 0          0 enp0s3
172.16.0.0      0.0.0.0         255.255.255.0   U         0 0          0 enp0s8
192.168.0.0     0.0.0.0         255.255.255.0   U         0 0          0 enp0s3
```

</details>

- 라우팅 테이블 `route`

```bash
route --numeric
# 또는
route -n
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .label .label-green }

```bash
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.0.1     0.0.0.0         UG    0      0        0 enp0s3
0.0.0.0         172.16.0.1      0.0.0.0         UG    0      0        0 enp0s8
172.16.0.0      0.0.0.0         255.255.255.0   U     0      0        0 enp0s8
192.168.0.0     0.0.0.0         255.255.255.0   U     0      0        0 enp0s3
```

</details>

- 라우팅 테이블 `iproute2`

```bash
ip route list
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .label .label-green }

```
default via 192.168.0.1 dev enp0s3 proto static
default via 172.16.0.1 dev enp0s8 proto static
172.16.0.0/24 dev enp0s8 proto kernel scope link src 172.16.0.6
192.168.0.0/24 dev enp0s3 proto kernel scope link src 192.168.0.35
```

</details>

- systemd-networkd `enp0s3` 인터페이스 네트워크 구성 정보

```bash
cat /run/systemd/network/10-netplan-enp0s3.network
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .label .label-green }

```bash
[Match]
Name=enp0s3

[Link]
RequiredForOnline=no

[Network]
LinkLocalAddressing=ipv6
Address=192.168.0.35/24
Gateway=192.168.0.1
DNS=164.124.101.2
DNS=210.220.163.82
DNS=1.1.1.1
DNS=8.8.8.8

[Route]
Destination=0.0.0.0/0
Gateway=192.168.0.1
Metric=100
Table=101

[RoutingPolicyRule]
From=192.168.0.0/24
Table=101
```

</details>

- systemd-networkd `enp0s8` 인터페이스 네트워크 구 정보

```bash
cat /run/systemd/network/10-netplan-enp0s8.network
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .label .label-green }

```bash
[Match]
Name=enp0s8

[Link]
RequiredForOnline=no

[Network]
LinkLocalAddressing=ipv6
Address=172.16.0.6/24
Gateway=172.16.0.1
DNS=164.124.101.2
DNS=210.220.163.82
DNS=1.1.1.1
DNS=8.8.8.8
```

</details>

- `enp0s3` NIC Ping 테스트

```bash
ping -w 1 8.8.8.8 -I enp0s3
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .label .label-green }

```bash
PING 8.8.8.8 (8.8.8.8) from 192.168.0.35 enp0s3: 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=56 time=34.0 ms

--- 8.8.8.8 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 34.003/34.003/34.003/0.000 ms
```

</details>

- `enp0s8` NIC Ping 테스트

```bash
ping -w 1 8.8.8.8 -I enp0s8
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .label .label-green }

```bash
PING 8.8.8.8 (8.8.8.8) from 172.16.0.6 enp0s8: 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=55 time=32.2 ms

--- 8.8.8.8 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 32.240/32.240/32.240/0.000 ms
```

</details>

> - Gateway 메트릭 설정 안된 경우
```bash
PING 8.8.8.8 (8.8.8.8) from 172.16.0.6 enp0s8: 56(84) bytes of data.

--- 8.8.8.8 ping statistics ---
1 packets transmitted, 0 received, 100% packet loss, time 0ms
```
>
{: .important}

- 영구적용 스크립트

```bash
echo "\
1       rt2" \
>> /etc/iproute2/rt_tables

echo '#!/usr/bin/env bash

ip route add default via 192.168.0.1 dev eth1 table rt2
ip route add 192.168.0.0/24 dev eth1 src 192.168.0.35 table rt2
ip rule add from 192.168.0.35/32 table rt2
ip rule add to 192.168.0.35/32 table rt2' \
> /etc/rc.local

chmod 700 /etc/rc.local
```
