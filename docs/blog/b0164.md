---
layout: default
title: OpenStack-Ansible 구성
parent: Blog
grand_parent: Category
permalink: docs/category/blog/b0164
child_nav_order: desc
---

# OpenStack-Ansible 구성

<details open markdown="block">
  <summary>
    Table of contents
  </summary>
  {: .no_toc .text-delta .label .label-green }
1. TOC
{:toc}
</details>

---

## 개요

{: .new }
> - OpenStack-Ansible 구성
> - [OpenStack-Ansible Documents](https://docs.openstack.org/openstack-ansible/latest/id/user/aio/quickstart.html)

{: .note }
>
| 순서   | 서비스                   | 도구               | 설명                                                                  |
|:------|:-----------------------|:------------------|:---------------------------------------------------------------------|
| 1    | Identity service      | Keystone        | OpenStack의 인증 및 권한 부여 서비스로, 사용자와 서비스 간의 인증 및 권한 관리를 담당합니다. |
| 2    | Image service         | Glance          | 운영체제 이미지의 저장 및 관리 서비스로, 가상 머신과 베어메탈 인스턴스의 이미지 리소스를 제공합니다. |
| 3    | Placement service     | Placement       | 자원의 배치 및 할당을 관리하여, 가상 머신과 인스턴스에 필요한 리소스를 효율적으로 배정합니다. |
| 4    | Compute service       | Nova            | 가상 머신 또는 베어메탈 인스턴스를 생성하고 관리하는 핵심 서비스로, 클라우드 컴퓨팅 리소스를 제공합니다. |
| 5    | Networking service    | Neutron         | 네트워킹 설정과 관리 기능을 제공하여, 가상 네트워크와 물리 네트워크 간의 통신을 지원합니다. |
| 6    | Dashboard             | Horizon         | OpenStack 대시보드로, 웹 기반의 사용자 인터페이스를 통해 클라우드 리소스를 관리할 수 있습니다. |
| 7    | Block Storage service | Cinder          | 블록 스토리지 서비스를 제공하여, 인스턴스에 추가할 수 있는 영구 스토리지 볼륨을 관리합니다. |

### 배포 호스트 준비

#### 운영 체제 구성

```bash
# 패키지 소스 목록 업데이트
apt-get update
# 시스템 패키지 및 커널 업그레이드
apt-get dist-upgrade
# 호스트 재부팅
reboot
# 추가 소프트웨어 패키지 설치
apt install build-essential git chrony openssh-server python3-dev sudo
```

#### SSH 키 구성

#### 네트워크 구성

```bash
cat <<EOF > /etc/netplan/01-netcfg.yaml 
# This is the network config written by 'subiquity'
network:
    version: 2
    ethernets:
        eno1:
            mtu: 9000
        eno2:
            mtu: 9000
    bonds:
        bond0:
            interfaces:
            - eno1
            - eno2
            mtu: 9000
            parameters:
                lacp-rate: fast
                mii-monitor-interval: 100
                mode: 802.3ad
                transmit-hash-policy: layer3+4
    vlans:
        bond0.10:
            id: 10
            link: bond0
        bond0.20:
            id: 20
            link: bond0
        bond0.30:
            id: 30
            link: bond0
        bond0.40:
            id: 40
            link: bond0
    bridges:
        br-mgmt:
            addresses:
            - 172.29.236.10/22
            interfaces:
            - bond0.10
            mtu: 9000
            nameservers:
                addresses:
                - 8.8.8.8
                - 8.8.4.4
                search:
                - example.com
        br-storage:
            addresses:
            - 172.21.244.10/22
            interfaces:
            - bond0.20
            mtu: 9000
            openvswitch: {}
        br-vxlan:
            addresses:
            - 172.29.240.10/22
            interfaces:
            - bond0.30
            mtu: 9000
        br-ext:
            addresses:
            - 192.1.1.10/22
            interfaces:
            - bond0.40
            gateway4: 192.1.1.1
        br-vlan:
            interfaces: bond0
            mtu: 9000
EOF
```

#### 소스 및 종속성 설치

```bash
# /opt/openstack-ansible 디렉토리에 있는 OpenStack-Ansible Git 저장소의 최신 안정 릴리스 복제
git clone -b 29.0.2 https://opendev.org/openstack/openstack-ansible /opt/openstack-ansible
cd /opt/openstack-ansible
# Ansible 부트스트랩 스크립트 실행
scripts/bootstrap-ansible.sh
```

```bash
# 기존 태그를 모두 나열
git tag -l

# 안정적인 브랜치 체크아웃
git checkout tags/29.0.2
# 안정적인 브랜치 확인
git describe --abbrev=0 --tags

# 최신 브랜치 체크아웃
# git checkout master
```

### 대상 호스트 준비

#### 운영 체제 구성

```bash
# 패키지 소스 목록 업데이트
apt-get update
# 시스템 패키지 및 커널 업그레이드
apt-get dist-upgrade
# 추가 소프트웨어 패키지 설치
apt install bridge-utils debootstrap openssh-server tcpdump vlan python3
# 추가 커널 패키지 설치
apt install linux-modules-extra-$(uname -r)
# 호스트 재부팅
reboot
```

#### SSH 키 구성

```bash
ssh-copy-id -i ~/.ssh/id_ed25519.pub 10.1.81.101
```

#### 저장소 구성

```bash
lsblk
NAME  MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
xvda1 202:1    0    1G  0 disk [SWAP]
xvda2 202:2    0  100G  0 disk /
xvdb  202:16   0  100G  0 disk
```

```bash
pvcreate --metadatasize 2048 physical_volume_device_path
vgcreate cinder-volumes physical_volume_device_path
```
#### 네트워크 구성

### 배포 구성

#### 초기 환경 구성

```bash
# 파일 복사
cd /opt/openstack-ansible/
cp -rv /opt/openstack-ansible/etc/openstack_deploy /etc/openstack_deploy
cp -v  /etc/openstack_deploy/openstack_user_config.yml.example /etc/openstack_deploy/openstack_user_config.yml
for f in $(ls -1 /etc/openstack_deploy/conf.d/*.aio); do mv -v ${f} ${f%.*}; done
find /etc/openstack_deploy/conf.d -type f -name "*" \
! -name "keystone.yml" \
! -name "glance.yml" \
! -name "placement.yml" \
! -name "nova.yml" \
! -name "neutron.yml" \
! -name "horizon.yml" \
! -name "cinder.yml" \
-exec rm {} +
```
#### 추가 서비스 설치

```bash
sed -i 's/172.29.236.100/10.1.81.100/g' /etc/openstack_deploy/conf.d/{keystone.yml,glance.yml,placement.yml,nova.yml,neutron.yml,horizon.yml,cinder.yml}
```

#### 고급 서비스 구성
#### 서비스 자격 증명 구성

```bash
cd /opt/openstack-ansible
./scripts/pw-token-gen.py --file /etc/openstack_deploy/user_secrets.yml
```

### 플레이북 실행

#### 구성 파일의 무결성 확인

```bash
cd /opt/openstack-ansible/playbooks
openstack-ansible setup-infrastructure.yml --syntax-check
```

#### OpenStack을 설치하기 위한 플레이북 실행

```bash
cd /opt/openstack-ansible/playbooks
openstack-ansible setup-everything.yml
openstack-ansible setup-hosts.yml
openstack-ansible setup-infrastructure.yml
openstack-ansible setup-openstack.yml
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }
  
```bash

```

</details>
