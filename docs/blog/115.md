---
layout: default
title: IPXE boot
parent: Blog
grand_parent: Category
permalink: docs/category/blog/115
child_nav_order: desc
---
# iPXE boot
<details open markdown="block">
  <summary>
    Table of contents
  </summary>
  {: .no_toc .text-delta .label .label-green }
1. TOC
{:toc}
</details>
---

## 개요

> - iPXE(Internet Preboot eXecution Environment) boot
> - [참조](https://gist.github.com/rikka0w0/50895b82cbec8a3a1e8c7707479824c1#file-ipxe_build-md)
{: .new }

### 도구 설치 및 IPXE 구성

- Install compiler and dependencies

```bash
apt install -y build-essential liblzma-dev isolinux git
```

- ipxe source code

```bash
git clone https://github.com/ipxe/ipxe.git
cd ipxe/src
```

- Enable NFS support

```bash
sed -i 's/#undef\tDOWNLOAD_PROTO_NFS/#define\tDOWNLOAD_PROTO_NFS/' config/general.h
```

- Enable Ping support

```bash
sed -i 's/\/\/#define\ PING_CMD/#define\ PING_CMD/' config/general.h
sed -i 's/\/\/#define\ IPSTAT_CMD/#define\ IPSTAT_CMD/' config/general.h
sed -i 's/\/\/#define\ REBOOT_CMD/#define\ REBOOT_CMD/' config/general.h
sed -i 's/\/\/#define\ POWEROFF/#define\ POWEROFF/' config/general.h
```

### 내장된 스크립트 생성

- Create the embedded script

```bash
#!ipxe

dhcp
chain tftp://${next-server}/main.ipxe || shell
```

### IPXE 컴파일

- Compile IPXE

```bash
make bin/undionly.kpxe EMBED=/root/ipxe/src/embed.ipxe
```

### TFTP 루트에 bin/undionly.kpxe 업로드

```bash
mkdir -p /srv/tftp/ipxe/bin/
cp -av bin/undionly.kpxe /srv/tftp/ipxe/bin/
```

### DNS 서버 구성

- Configure DNS server

```bash
IPADD=$(hostname -I | awk '{print $1}')
IPGW=$(ip route | grep default | head -n 1 | awk '{print $3}')
IPADD_PREFIX=$(echo $IPADD | sed 's/\.[0-9]*$//')
cat << EOF >> /etc/dhcp/dhcpd.conf

subnet 192.168.0.0 netmask 255.255.255.0 {
 option routers                  $IPGW;
 option subnet-mask              255.255.255.0;
 option domain-name-servers      1.1.1.1, 8.8.8.8;
 option domain-name              "ipxe-boot.com";
 option time-offset              32400;     # Timezone: Asia/Seoul
 range $IPADD_PREFIX.100 $IPADD_PREFIX.200;
 next-server $IPADD;
 filename "ipxe/bin/undionly.kpxe";
}
EOF
```

### TFTP 루트에 main.ipxe 생성

```bash
```

<details markdown="block">
  <summary>
    결과
  </summary>
  {: .text-delta }
  
```bash
nmap --script ssh2-enum-algos 192.168.0.1
```

</details>
{: .label .label-green }

```bash
tee /root/embed.ipxe << EOF
#!ipxe
set esc:hex 1b
set bold \${esc:string}[1m
set boldoff \${esc:string}[22m
set fg_gre \${esc:string}[32m
set fg_cya \${esc:string}[36m
set fg_whi \${esc:string}[37m
set site_name netboot.xyz
set boot_domain boot.netboot.xyz
set ipxe_version \${version}
set version 2.x
set conn_type https

:start
echo \${bold}\${fg_gre}\${site_name} - \${fg_whi}v\${version}\${boldoff}
iseq \${site_name} netboot.xyz || echo \${bold}\${fg_whi}Powered by \${fg_gre}netboot.xyz\${fg_whi}\${boldoff}
prompt --key s --timeout 10000 Hit the \${bold}s\${boldoff} key to open failsafe menu... && goto failsafe || goto dhcp

:dhcp
echo
dhcp && goto netboot || goto netconfig
isset ${next-server}

:netboot
chain tftp://\${next-server}/main.ipxe ||
prompt --key s --timeout 10000 Hit the \${bold}s\${boldoff} key to open failsafe menu... && goto failsafe || goto dhcp

:failsafe
menu Failsafe Menu
item --gap -- ------------------ Local boot options ------------------
item localboot Boot to local drive
item --gap -- ------------------ Network boot options ----------------
item netconfig Manual network configuration
item retry Retry boot
item debug iPXE Debug Shell
item reboot Reboot System
choose failsafe_choice || exit
goto \${failsafe_choice}

:netconfig
echo Network Configuration:
echo Available interfaces...
ifstat
imgfree
echo -n Set network interface number [0 for net0, defaults to 0]: \${} && read net
isset \${net} || set net 0
echo -n IP: && read net\${net}/ip
echo -n Subnet mask: && read net\${net}/netmask
echo -n Gateway: && read net\${net}/gateway
echo -n DNS: && read dns
ifopen net\${net}
echo Attempting chainload of \${boot_domain}...
goto start || goto failsafe

:localboot
exit

:retry
goto start

:reboot
reboot
goto start

:debug
echo Type "exit" to return to menu
shell
goto failsafe
EOF
```





```bash
#!ipxe

set server_ip 192.168.0.40
set root_path /var/www/html/pxe

:MENU
menu Operating System boot options
item --gap -- ---------------- Local boot options ------------------
item localboot Boot to local drive
item --gap -- ---------------- Network boot options ----------------
item Ubuntu22.04   Install Ubuntu 22.04
item Ubuntu20.04   Install Ubuntu 20.04
item Windows10     Install Windows10
item --gap -- ---------------- Advanced options ----------------
item debug iPXE Debug Shell
item reboot Reboot System

choose --default return --timeout 10000 target && goto ${target}

:ubuntu22.04
set os_root ${root_path}/ubuntu22.04
kernel tftp://${server_ip}/${os_root}/casper/vmlinuz
initrd tftp://${server_ip}/${os_root}/casper/initrd
imgargs vmlinuz initrd=initrd boot=casper maybe-ubiquity netboot=nfs ip=dhcp nfsroot=${server_ip}:${root_path}/${os_root} quiet splash ---
boot

:ubuntu20.04
set os_root ubuntu20.04
kernel tftp://${server_ip}/${os_root}/casper/vmlinuz
initrd tftp://${server_ip}/${os_root}/casper/initrd
imgargs vmlinuz initrd=initrd boot=casper maybe-ubiquity netboot=nfs ip=dhcp nfsroot=${server_ip}:${root_path}/${os_root} quiet splash ---
boot

:localboot
exit

:reboot
reboot

:debug
echo Type "exit" to return to menu
shell
goto MENU
```
