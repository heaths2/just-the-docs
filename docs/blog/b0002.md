---
layout: default
title: Kubernetes 설치방법
parent: Blog
grand_parent: Category
permalink: docs/category/blog/b0002
child_nav_order: desc
---

# Kubernetes, k8s

<details open markdown="block">
  <summary>
    Table of contents
  </summary>
  {: .no_toc .text-delta .label .label-green }
1. TOC
{:toc}
</details>

---

## 개요

{: .new }
> - Kubernetes 설치방법
> - [k8s 설치가이드 문서](https://kubernetes.io/ko/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#kubeadm-kubelet-및-kubectl-설치/)
> - Helm 설치방법
> - 

#### 환경구성

##### k8s 사용자

**k8s** 사용자 계정 생성

```bash
username="k8s"
password="1234"
useradd -m "$username" -d "/home/$username" -p "$(openssl passwd -6 "$password")" -s /bin/bash -c "Kubernetes"

# sudoers 권한 추가
sudo sed -i '/^root\s\+ALL=(ALL:ALL) ALL/a k8s     ALL=(ALL:ALL) ALL' /etc/sudoers
su - k8s
```

##### **Swap 메모리**

**Swap 메모리** 비활성화

- Swap 메모리: Swap 메모리 사용시 성능 이슈(느려짐)가 발생될 수 있기 때문에 Off 설정

##### **네트워크 포워딩**

**네트워크 포워딩** 활성화

```bash
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.ipv4.ip_forward = 1
EOF

# 시스템 설정 적용 변경 사항 즉시 활성화
sudo sysctl --system

# 설정 적용 확인
sudo sysctl net.ipv4.ip_forward
```

##### 컨테이너 런타임

**컨테이너 런타임** 설치

{: .important }
> - 컨테이너 런타임: containerd, CRI-O, docker
> 
| **컨테이너 런타임** | **설명**                                             | **주요 특징**                                             | **적합한 사용 사례**                                          |
|--------------------|----------------------------------------------------|--------------------------------------------------------|-----------------------------------------------------------|
| **containerd**      | Docker에서 분리된 독립적인 런타임, Kubernetes에서 기본 런타임으로 사용                      | - Kubernetes와 기본적으로 호환됨<br>- 이미지 관리 및 컨테이너 라이프사이클 관리 | - Kubernetes 클러스터에서 기본 런타임                         |
| **CRI-O**           | Kubernetes와의 통합을 위해 설계된 경량 런타임                                        | - Kubernetes와 최적화된 통합<br>- OCI 이미지 표준 준수<br>- 경량화된 설계   | - Kubernetes 환경에서만 사용                                  |
| **runc**            | OCI 표준을 준수하는 컨테이너 런타임의 기본 구현체                                    | - 낮은 수준의 시스템 호출로 컨테이너 실행<br>- OCI 표준 준수               | - 기본적인 컨테이너 실행에 사용, 다른 런타임의 핵심 구성 요소    |

```bash
sudo apt update
sudo apt install containerd -y
sudo mkdir -pv /etc/containerd
sudo containerd config default | sudo tee /etc/containerd/config.toml
sudo sed -i \
    -e 's|SystemdCgroup = .*|SystemdCgroup = true|' \
    -e 's|sandbox_image = .*|sandbox_image = "registry.k8s.io/pause:3.10"|' /etc/containerd/config.toml

sudo systemctl enable --now containerd
```

#### Kubernetes 설치

**kubeadm**, **kubelet**, **kubectl** 설치

```bash
sudo apt-get update
sudo apt-get install -y apt-transport-https ca-certificates curl gpg
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
sudo systemctl enable --now kubelet
```

- 설치 버전 확인

```bash
kubeadm version -o short
kubectl version
kubelet --version
```

##### Kubernetes 클러스터

**Kubernetes 클러스터** 초기 구성

- `--apiserver-advertise-address` 마스터 노드 IP 입력 및 pod 네트워크 대역 설정
  
```bash
kubeadm init --apiserver-advertise-address=220.71.21.173 --pod-network-cidr=192.168.0.0/16
```

```bash
root@MasterNode:~:> kubeadm init --apiserver-advertise-address=220.71.21.173 --pod-network-cidr=192.168.0.0/16
[init] Using Kubernetes version: v1.23.2
[preflight] Running pre-flight checks
	[WARNING Hostname]: hostname "masternode" could not be reached
	[WARNING Hostname]: hostname "masternode": lookup masternode on 168.126.63.1:53: no such host
[preflight] Pulling images required for setting up a Kubernetes cluster
[preflight] This might take a minute or two, depending on the speed of your internet connection
[preflight] You can also perform this action in beforehand using 'kubeadm config images pull'
[certs] Using certificateDir folder "/etc/kubernetes/pki"
[certs] Generating "ca" certificate and key
[certs] Generating "apiserver" certificate and key
[certs] apiserver serving cert is signed for DNS names [kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local masternode] and IPs [10.96.0.1 220.71.21.173]
[certs] Generating "apiserver-kubelet-client" certificate and key
[certs] Generating "front-proxy-ca" certificate and key
[certs] Generating "front-proxy-client" certificate and key
[certs] Generating "etcd/ca" certificate and key
[certs] Generating "etcd/server" certificate and key
[certs] etcd/server serving cert is signed for DNS names [localhost masternode] and IPs [220.71.21.173 127.0.0.1 ::1]
[certs] Generating "etcd/peer" certificate and key
[certs] etcd/peer serving cert is signed for DNS names [localhost masternode] and IPs [220.71.21.173 127.0.0.1 ::1]
[certs] Generating "etcd/healthcheck-client" certificate and key
[certs] Generating "apiserver-etcd-client" certificate and key
[certs] Generating "sa" key and public key
[kubeconfig] Using kubeconfig folder "/etc/kubernetes"
[kubeconfig] Writing "admin.conf" kubeconfig file
[kubeconfig] Writing "kubelet.conf" kubeconfig file
[kubeconfig] Writing "controller-manager.conf" kubeconfig file
[kubeconfig] Writing "scheduler.conf" kubeconfig file
[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[kubelet-start] Starting the kubelet
[control-plane] Using manifest folder "/etc/kubernetes/manifests"
[control-plane] Creating static Pod manifest for "kube-apiserver"
[control-plane] Creating static Pod manifest for "kube-controller-manager"
[control-plane] Creating static Pod manifest for "kube-scheduler"
[etcd] Creating static Pod manifest for local etcd in "/etc/kubernetes/manifests"
[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory "/etc/kubernetes/manifests". This can take up to 4m0s
[apiclient] All control plane components are healthy after 15.004206 seconds
[upload-config] Storing the configuration used in ConfigMap "kubeadm-config" in the "kube-system" Namespace
[kubelet] Creating a ConfigMap "kubelet-config-1.23" in namespace kube-system with the configuration for the kubelets in the cluster
NOTE: The "kubelet-config-1.23" naming of the kubelet ConfigMap is deprecated. Once the UnversionedKubeletConfigMap feature gate graduates to Beta the default name will become just "kubelet-config". Kubeadm upgrade will handle this transition transparently.
[upload-certs] Skipping phase. Please see --upload-certs
[mark-control-plane] Marking the node masternode as control-plane by adding the labels: [node-role.kubernetes.io/master(deprecated) node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]
[mark-control-plane] Marking the node masternode as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]
[bootstrap-token] Using token: iswoxr.lr1nxeorkdmjcq5d
[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get nodes
[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials
[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster
[bootstrap-token] Creating the "cluster-info" ConfigMap in the "kube-public" namespace
[kubelet-finalize] Updating "/etc/kubernetes/kubelet.conf" to point to a rotatable kubelet client certificate and key
[addons] Applied essential addon: CoreDNS
[addons] Applied essential addon: kube-proxy
Your Kubernetes control-plane has initialized successfully!
To start using your cluster, you need to run the following as a regular user:
  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config
Alternatively, if you are the root user, you can run:
  export KUBECONFIG=/etc/kubernetes/admin.conf
You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/
Then you can join any number of worker nodes by running the following on each as root:
kubeadm join 220.71.21.173:6443 --token iswoxr.lr1nxeorkdmjcq5d \
	--discovery-token-ca-cert-hash sha256:d439c08fd4a2e480afdcfed1daef6b60be4f3fe0195c0c4dbb669e4335bb88f3
```

**Kubernetes 클러스터** 관리자 권한 설정

```bash
mkdir -pv $HOME/.kube
cp -iv /etc/kubernetes/admin.conf $HOME/.kube/config
chown -v $(id -u):$(id -g) $HOME/.kube/config
```

##### 플러그인 설치

**Calico CNI** 설치

```bash
kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
```

**Flannel CNI** 설치

```bash
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
```

token 확인
```bash
root@MasterNode:~:> kubeadm token list
TOKEN                     TTL         EXPIRES                USAGES                   DESCRIPTION                                                EXTRA GROUPS
iswoxr.lr1nxeorkdmjcq5d   23h         2022-01-21T07:37:49Z   authentication,signing   The default bootstrap token generated by 'kubeadm init'.   system:bootstrappers:kubeadm:default-node-token
```
최초에 발행된 토큰의 경우 24시간 이후 만료
```bash
root@MasterNode:~:> kubeadm token create --help
...
Usage:
  kubeadm token create [token]
Flags:
      --ttl duration             The duration before the token is automatically deleted (e.g. 1s, 2m, 3h). If set to '0', the token will never expire (default 24h0m0s)
...
```
token 영구 발행
```bash
root@MasterNode:~:> kubeadm token create --ttl=0
kyta69.5vnv9usviu8l8p8a
root@MasterNode:~:> kubeadm token list
TOKEN                     TTL         EXPIRES                USAGES                   DESCRIPTION                                                EXTRA GROUPS
iswoxr.lr1nxeorkdmjcq5d   22h         2022-01-21T07:37:49Z   authentication,signing   The default bootstrap token generated by 'kubeadm init'.   system:bootstrappers:kubeadm:default-node-token
kyta69.5vnv9usviu8l8p8a   <forever>   <never>   authentication,signing   <none>                                                     system:bootstrappers:kubeadm:default-node-token
```
hash값 확인
```bash
root@MasterNode:~:> openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'
5214bb49a0b380696e203a361194710fad8a1e0647233f76776849b0b0c3c7a1
```
#### kubeadm join
WorkerNode1, WorkerNode2 root 또는 sudo로 진행
```bash
root@WorkerNode1:~:> kubeadm join 220.71.21.173:6443 --token iswoxr.lr1nxeorkdmjcq5d \
	--discovery-token-ca-cert-hash sha256:d439c08fd4a2e480afdcfed1daef6b60be4f3fe0195c0c4dbb669e4335bb88f3
root@WorkerNode2:~:> kubeadm join 220.71.21.173:6443 --token iswoxr.lr1nxeorkdmjcq5d \
	--discovery-token-ca-cert-hash sha256:d439c08fd4a2e480afdcfed1daef6b60be4f3fe0195c0c4dbb669e4335bb88f3
```
연결된 노드 정보
```bash
root@MasterNode:~:> kubectl get nodes --all-namespaces
NAME      STATUS   ROLES                  AGE   VERSION
MasterNode    Ready    control-plane,master   11m   v1.23.2
WorkerNode1   Ready    <none>                 75s   v1.23.2
WorkerNode2   Ready    <none>                 75s   v1.23.2
```
연결된 파드 정보
```bash
root@MasterNode:~:> kubectl get pods --all-namespaces --output=wide
NAMESPACE     NAME                                 READY   STATUS              RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES
kube-system   coredns-64897985d-8zxd6              0/1     ContainerCreating   0          54m   <none>          masternode   <none>           <none>
kube-system   coredns-64897985d-dp749              0/1     ContainerCreating   0          54m   <none>          masternode   <none>           <none>
kube-system   etcd-masternode                      1/1     Running             3          54m   220.71.21.173   masternode   <none>           <none>
kube-system   kube-apiserver-masternode            1/1     Running             2          54m   220.71.21.173   masternode   <none>           <none>
kube-system   kube-controller-manager-masternode   1/1     Running             2          54m   220.71.21.173   masternode   <none>           <none>
kube-system   kube-proxy-5rh4w                     1/1     Running             0          54m   220.71.21.173   masternode   <none>           <none>
kube-system   kube-scheduler-masternode            1/1     Running             3          54m   220.71.21.173   masternode   <none>           <none>
```
※ [칼리코](https://projectcalico.docs.tigera.io/getting-started/kubernetes/self-managed-onprem/onpremises/) 참고사이트
```bash
kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
```
```bash
root@MasterNode:~:> kubectl get pods --all-namespaces --output=wide
NAMESPACE              NAME                                         READY   STATUS    RESTARTS      AGE     IP              NODE         NOMINATED NODE   READINESS GATES
kube-system            calico-kube-controllers-85b5b5888d-mpwgt     1/1     Running   0             44s     192.168.181.6   masternode   <none>           <none>
kube-system            calico-node-45vnr                            1/1     Running   0             44s     220.71.21.173   masternode   <none>           <none>
kube-system            coredns-5cc6c6d8b5-jrk2z                     1/1     Running   0             8m44s   192.168.181.5   masternode   <none>           <none>
kube-system            coredns-5cc6c6d8b5-nnctc                     1/1     Running   0             8m44s   192.168.181.4   masternode   <none>           <none>
kube-system            etcd-masternode                              1/1     Running   3             76m     220.71.21.173   masternode   <none>           <none>
kube-system            kube-apiserver-masternode                    1/1     Running   2             76m     220.71.21.173   masternode   <none>           <none>
kube-system            kube-controller-manager-masternode           1/1     Running   2             76m     220.71.21.173   masternode   <none>           <none>
kube-system            kube-proxy-5rh4w                             1/1     Running   0             76m     220.71.21.173   masternode   <none>           <none>
kube-system            kube-scheduler-masternode                    1/1     Running   3             76m     220.71.21.173   masternode   <none>           <none>
kube-system            weave-net-qzsql                              2/2     Running   1 (20m ago)   20m     220.71.21.173   masternode   <none>           <none>
kubernetes-dashboard   dashboard-metrics-scraper-799d786dbf-7nmcq   1/1     Running   0             17m     192.168.181.1   masternode   <none>           <none>
kubernetes-dashboard   kubernetes-dashboard-6b6b86c4c5-flx5z        1/1     Running   0             17m     192.168.181.2   masternode   <none>           <none>
```
### 쿠버네티스 대시보드를 배포하고 접속하기
※ [공식문서](https://kubernetes.io/ko/docs/tasks/access-application-cluster/web-ui-dashboard/) 참고사이트
대시보드 UI 배포
```bash
kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.4.0/aio/deploy/recommended.yaml
```
대시보드로의 접속을 활성화
```bash
kubectl proxy
```
대시보드 UI 접속
```bash
 http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/
```
![kubeadm-token-auth](https://user-images.githubusercontent.com/36792594/150469046-c7dcceaf-8d50-4e27-9a56-535d9b11864f.png){: .align-center}
[그림1]
### kubeadm, kubectl 자동완성 기능
※ [자동완성](https://kubernetes.io/ko/docs/tasks/tools/included/optional-kubectl-configs-bash-linux/) 참고사이트
```bash
kubeadm completion bash >/etc/bash_completion.d/kubeadm
source /etc/bash_completion.d/kubeadm
kubectl completion bash >/etc/bash_completion.d/kubectl
source /etc/bash_completion.d/kubectl
```
### Error
오류
```bash
[kubelet-check] The HTTP call equal to 'curl -sSL http://localhost:10248/healthz' failed with error: Get "http://localhost:10248/healthz": dial tcp 127.0.0.1:10248: connect: connection refused.
```
해결
```bash
swapoff > daemon.json > systemctl restart docker;systemctl restart kubelet;
```
