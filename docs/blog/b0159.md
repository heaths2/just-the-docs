---
layout: default
title: Internet Small Computer System Interface
parent: Blog
grand_parent: Category
permalink: docs/category/blog/b0159
child_nav_order: desc
---

# iSCSI 구성

<details open markdown="block">
  <summary>
    Table of contents
  </summary>
  {: .no_toc .text-delta .label .label-green }
1. TOC
{:toc}
</details>

---

## 개요

> - iSCSI 구성
{: .new }

### iSCSI Target

#### SCST 설치

##### **필수 패키지 설치**

```bash
sudo apt update
sudo apt install build-essential debhelper devscripts gcc make linux-headers-$(uname -r) lintian quilt
```

##### **SCST 소스 코드 다운로드**

```bash
git clone https://github.com/SCST-project/scst.git
cd scst
```

##### **SCST Debian 패키지(.deb) 파일로 패키징 및 설치**

```bash
make dpkg
sudo dpkg -i ./dpkg/{scst,iscsi-scst,scstadmin}_*.deb
```

##### **SCST 모듈 로드**

```bash
sudo modprobe scst
sudo depmod
sudo modprobe iscsi-scst
sudo modprobe scst_disk scst_tape scst_processor scst_cdrom scst_modisk scst_changer scst_raid scst_vdisk scst_user
```

##### **SCST 자동 모듈 로드 설정**

```bash
echo "\
iscsi-scst
scst_vdisk
scst_disk
scst_user
scst_modisk
scst_processor
scst_raid
scst_tape
scst_cdrom
scst_changer" | sudo tee -a /etc/modules
```

{: .important }
> **SCST 모듈**
>
> | 모듈 이름        | 설명                                                     | 장치 유형 (Type)                   |
> |:-----------------|:--------------------------------------------------------|:-----------------------------------|
> | scst             | SCST 자체 (핵심 모듈)                                    | N/A                                |
> | iscsi-scst       | iSCSI 타겟 기능을 제공하는 모듈                          | N/A                                |
> | scst_disk        | 디스크용 장치 핸들러                                     | 0 (디스크)                         |
> | scst_tape        | 테이프용 장치 핸들러                                     | 1 (테이프)                         |
> | scst_processor   | 프로세서용 장치 핸들러                                   | 3 (프로세서)                       |
> | scst_cdrom       | CD-ROM용 장치 핸들러                                     | 5 (CD-ROM)                         |
> | scst_modisk      | MO 디스크용 장치 핸들러                                  | 7 (MO 디스크)                      |
> | scst_changer     | 미디어 체인저용 장치 핸들러                              | 8 (미디어 체인저)                  |
> | scst_raid        | 스토리지 배열 컨트롤러(예: RAID)용 핸들러                | C (스토리지 배열 컨트롤러)         |
> | scst_vdisk       | 가상 디스크(파일, 장치 또는 ISO CD 이미지)용 핸들러     | N/A                                |
> | scst_user        | 사용자 공간에서 동작하는 장치 핸들러                     | N/A                                |

#### **SCST 서비스 관리**

##### **SCST 서비스 시작**

```bash
systemctl start scst.service
```

##### **SCST 자동 시작 설정 설정**

```bash
systemctl enable scst
```

##### **SCST 기본 설정 생성**

```bash
sudo scstadmin -write_config /etc/scst.conf
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }

```bash
# Automatically generated by SCST Configurator v3.9.0-pre.


HANDLER vdisk_blockio {
    DEVICE disk01 {
        filename /dev/Disks/data01
        blocksize 512
        nv_cache 0
        read_only 0
        removable 0
    }
    DEVICE disk02 {
        filename /dev/Disks/data02
        blocksize 4096
        nv_cache 1
        read_only 0
        removable 0
    }
    DEVICE disk03 {
        filename /dev/Disks/data03
    }    
}

TARGET_DRIVER iscsi {
        enabled 1

        TARGET sv01 {
                enabled 1
                allowed_portal 10.1.200.*

                GROUP sv01 {
                        LUN 0 disk01
                        LUN 1 disk02
                        INITIATOR sv01 
                }
        }
        TARGET sv02 {
                enabled 1

                GROUP sv02 {
                        LUN 0 disk03
                        INITIATOR sv02
                }
        }
}
```

</details>

##### **SCST 상세 정보**

```bash
cat /sys/kernel/scst_tgt/handlers/vdisk_blockio/*/{filename,blocksize,nv_cache,read_only,removable}
cat /sys/kernel/scst_tgt/handlers/vdisk_blockio/*/filename
cat /sys/kernel/scst_tgt/handlers/vdisk_blockio/*/blocksize
cat /sys/kernel/scst_tgt/handlers/vdisk_blockio/*/nv_cache
cat /sys/kernel/scst_tgt/handlers/vdisk_blockio/*/read_only
cat /sys/kernel/scst_tgt/handlers/vdisk_blockio/*/removable
cat /sys/kernel/scst_tgt/handlers/vdisk_blockio/*/naa_id
```

```bash
tree /sys/kernel/scst_tgt/targets/iscsi
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }

```bash
/sys/kernel/scst_tgt/targets/iscsi
├── sv01
│   ├── DataDigest
│   ├── FirstBurstLength
│   ├── HeaderDigest
│   ├── ImmediateData
│   ├── InitialR2T
│   ├── MaxBurstLength
│   ├── MaxOutstandingR2T
│   ├── MaxRecvDataSegmentLength
│   ├── MaxSessions
│   ├── MaxXmitDataSegmentLength
│   ├── NopInInterval
│   ├── NopInTimeout
│   ├── QueuedCommands
│   ├── RDMAExtensions
│   ├── RspTimeout
│   ├── addr_method
│   ├── aen_disabled
│   ├── alias
│   ├── allowed_portal
│   ├── bidi_cmd_count
│   ├── bidi_io_count_kb
│   ├── bidi_unaligned_cmd_count
│   ├── black_hole
│   ├── comment
│   ├── cpu_mask
│   ├── enabled
│   ├── forward_dst
│   ├── forward_src
│   ├── forwarding
│   ├── ini_groups
│   │   ├── sv01
│   │   │   ├── addr_method
│   │   │   ├── black_hole
│   │   │   ├── cpu_mask
│   │   │   ├── initiators
│   │   │   │   ├── sv01
│   │   │   │   └── mgmt
│   │   │   ├── io_grouping_type
│   │   │   ├── luns
│   │   │   │   ├── 0
│   │   │   │   │   ├── device -> ../../../../../../../devices/data01
│   │   │   │   │   └── read_only
│   │   │   │   ├── 1
│   │   │   │   │   ├── device -> ../../../../../../../devices/data02
│   │   │   │   │   └── read_only
│   │   │   │   └── mgmt
│   │   │   └── per_sess_dedicated_tgt_threads
│   │   └── mgmt
│   ├── io_grouping_type
│   ├── luns
│   │   └── mgmt
│   ├── none_cmd_count
│   ├── per_portal_acl
│   ├── read_cmd_count
│   ├── read_io_count_kb
│   ├── read_unaligned_cmd_count
│   ├── redirect
│   ├── rel_tgt_id
│   ├── sessions
│   │   └── sv01
│   │       ├── 10.1.200.200
│   │       │   ├── cid
│   │       │   ├── ip
│   │       │   ├── state
│   │       │   └── target_ip
│   │       ├── DataDigest
│   │       ├── FirstBurstLength
│   │       ├── HeaderDigest
│   │       ├── ImmediateData
│   │       ├── InitialR2T
│   │       ├── MaxBurstLength
│   │       ├── MaxOutstandingR2T
│   │       ├── MaxRecvDataSegmentLength
│   │       ├── MaxXmitDataSegmentLength
│   │       ├── active_commands
│   │       ├── bidi_cmd_count
│   │       ├── bidi_io_count_kb
│   │       ├── bidi_unaligned_cmd_count
│   │       ├── commands
│   │       ├── force_close
│   │       ├── initiator_name
│   │       ├── latency
│   │       │   ├── b1024
│   │       │   ├── b131072
│   │       │   ├── b16384
│   │       │   ├── b2048
│   │       │   ├── b262144
│   │       │   ├── b32768
│   │       │   ├── b4096
│   │       │   ├── b512
│   │       │   ├── b524288
│   │       │   ├── b65536
│   │       │   ├── b8192
│   │       │   ├── n1024
│   │       │   ├── n131072
│   │       │   ├── n16384
│   │       │   ├── n2048
│   │       │   ├── n262144
│   │       │   ├── n32768
│   │       │   ├── n4096
│   │       │   ├── n512
│   │       │   ├── n524288
│   │       │   ├── n65536
│   │       │   ├── n8192
│   │       │   ├── r1024
│   │       │   ├── r131072
│   │       │   ├── r16384
│   │       │   ├── r2048
│   │       │   ├── r262144
│   │       │   ├── r32768
│   │       │   ├── r4096
│   │       │   ├── r512
│   │       │   ├── r524288
│   │       │   ├── r65536
│   │       │   ├── r8192
│   │       │   ├── w1024
│   │       │   ├── w131072
│   │       │   ├── w16384
│   │       │   ├── w2048
│   │       │   ├── w262144
│   │       │   ├── w32768
│   │       │   ├── w4096
│   │       │   ├── w512
│   │       │   ├── w524288
│   │       │   ├── w65536
│   │       │   └── w8192
│   │       ├── lun0
│   │       │   ├── active_commands
│   │       │   ├── thread_index
│   │       │   └── thread_pid
│   │       ├── lun1
│   │       │   ├── active_commands
│   │       │   ├── thread_index
│   │       │   └── thread_pid
│   │       ├── luns -> ../../ini_groups/sv01_data01/luns
│   │       ├── none_cmd_count
│   │       ├── read_cmd_count
│   │       ├── read_io_count_kb
│   │       ├── read_unaligned_cmd_count
│   │       ├── reinstating
│   │       ├── sid
│   │       ├── thread_pid
│   │       ├── unknown_cmd_count
│   │       ├── write_cmd_count
│   │       ├── write_io_count_kb
│   │       └── write_unaligned_cmd_count
│   ├── tid
│   ├── unknown_cmd_count
│   ├── write_cmd_count
│   ├── write_io_count_kb
│   └── write_unaligned_cmd_count
├── enabled
├── iSNSServer
├── internal_portal
├── isns_entity_name
├── link_local
├── mgmt
├── open_state
├── trace_level
└── version
```

</details>


##### **SCST 설정 적용**

```bash
sudo scstadmin -config /etc/scst.conf
```

##### **SCST 상태 확인**

```bash
sudo scstadmin -list_target -driver iscsi
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }

```bash
tcp: [4] 10.1.200.100:3260,1 sv01 (non-flash)
```

</details>

### iSCSI Initiator

##### **SCST Initiator 패키지 설치**

```bash
sudo apt install open-iscsi
```

##### **SCST IQN 변경**

```bash
sed -i "s/InitiatorName=.*/InitiatorName=$(hostname -s)/" /etc/iscsi/initiatorname.iscsi
sudo systemctl restart open-iscsi.service
```

##### **SCST 타겟 검색**

```bash
sudo iscsiadm -m discovery -t sendtargets -p 10.1.200.100
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }
  
```bash
10.1.200.100:3260,1 sv01
```

</details>

##### **SCST 모든 타겟 로그인**

```bash
sudo iscsiadm -m node -l
# 또는
sudo iscsiadm --mode node --login
```

##### **SCST 특정 타겟 로그인**

```bash
sudo iscsiadm -m node -T sv01 -p 10.1.200.100 -l
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }
  
```bash
Logging in to [iface: default, target: sv01, portal: 10.1.200.100,3260]
Login to [iface: default, target: sv01, portal: 10.1.200.100,3260] successful.
```

</details>

##### **SCST 세션 정보 확인**

```bash
sudo iscsiadm -m session
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }
  
```bash
tcp: [4] 10.1.200.100:3260,1 sv01 (non-flash)
```

</details>

##### **SCST 자동 연결 설정**

```bash
sudo iscsiadm -m node -T sv01 -p 10.1.200.100 -o update -n node.startup -v automatic
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }

```bash
# BEGIN RECORD 2.1.5
node.name = sv01
node.tpgt = 1
node.startup = automatic
node.leading_login = No
iface.iscsi_ifacename = default
iface.prefix_len = 0
iface.transport_name = tcp
iface.vlan_id = 0
iface.vlan_priority = 0
iface.iface_num = 0
iface.mtu = 0
iface.port = 0
iface.tos = 0
iface.ttl = 0
iface.tcp_wsf = 0
iface.tcp_timer_scale = 0
iface.def_task_mgmt_timeout = 0
iface.erl = 0
iface.max_receive_data_len = 0
iface.first_burst_len = 0
iface.max_outstanding_r2t = 0
iface.max_burst_len = 0
node.discovery_address = 10.1.200.100
node.discovery_port = 3260
node.discovery_type = send_targets
node.session.initial_cmdsn = 0
node.session.initial_login_retry_max = 8
node.session.xmit_thread_priority = -20
node.session.cmds_max = 128
node.session.queue_depth = 32
node.session.nr_sessions = 1
node.session.auth.authmethod = None
node.session.auth.chap_algs = MD5
node.session.timeo.replacement_timeout = 120
node.session.err_timeo.abort_timeout = 15
node.session.err_timeo.lu_reset_timeout = 30
node.session.err_timeo.tgt_reset_timeout = 30
node.session.err_timeo.host_reset_timeout = 60
node.session.iscsi.FastAbort = Yes
node.session.iscsi.InitialR2T = No
node.session.iscsi.ImmediateData = Yes
node.session.iscsi.FirstBurstLength = 262144
node.session.iscsi.MaxBurstLength = 16776192
node.session.iscsi.DefaultTime2Retain = 0
node.session.iscsi.DefaultTime2Wait = 2
node.session.iscsi.MaxConnections = 1
node.session.iscsi.MaxOutstandingR2T = 1
node.session.iscsi.ERL = 0
node.session.scan = auto
node.session.reopen_max = 0
node.conn[0].address = 10.1.200.100
node.conn[0].port = 3260
node.conn[0].startup = manual
node.conn[0].tcp.window_size = 524288
node.conn[0].tcp.type_of_service = 0
node.conn[0].timeo.logout_timeout = 15
node.conn[0].timeo.login_timeout = 15
node.conn[0].timeo.auth_timeout = 45
node.conn[0].timeo.noop_out_interval = 5
node.conn[0].timeo.noop_out_timeout = 5
node.conn[0].iscsi.MaxXmitDataSegmentLength = 0
node.conn[0].iscsi.MaxRecvDataSegmentLength = 262144
node.conn[0].iscsi.HeaderDigest = None
node.conn[0].iscsi.DataDigest = None
node.conn[0].iscsi.IFMarker = No
node.conn[0].iscsi.OFMarker = No
# END RECORD
```

</details>

{: .important }
>  **SCST 모든 타겟 자동연결 설정**
>  `# node.startup = automatic` → `node.startup = automatic` 주석 해제
>  `node.startup = manual` → `# node.startup = manual` 주석
```bash
/etc/iscsi/iscsid.conf
```

##### **SCST 모든 타겟 로그아웃**

```bash
sudo iscsiadm -m node -u
# 또는
sudo iscsiadm --mode node --logout
```

##### **SCST 특정 타겟 로그아웃**

```bash
sudo iscsiadm -m node -T sv01 -p 10.1.200.100 -u
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }

```bash
Logging out of session [sid: 10, target: sv01, portal: 10.1.200.100,3260]
Logout of [sid: 10, target: sv01, portal: 10.1.200.100,3260] successful.
```

</details>
