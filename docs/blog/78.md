---
layout: default
title: PowerDNS-Admin
parent: Blog
grand_parent: Category
permalink: docs/category/blog/78
child_nav_order: desc
---
# PowerDNS-Admin
<details open markdown="block">
  <summary>
    Table of contents
  </summary>
  {: .no_toc .text-delta .label .label-green }
1. TOC
{:toc}
</details>
---

## 개요

> - PowerDNS-Admin
> - [Repo PowerDNS](http://repo.powerdns.com/#ubuntu)
> - [docs powerdns installation](https://docs.brconsulting.info/en/docs/network/powerdns/02-pdns-installation/)
> - [Postgresql](https://www.postgresql.org/download/linux/ubuntu/)
{: .new }

### nmap으로 Clinet 키교환 방식 및 알고리즘 확인

```bash
apt update
```

- Install basic dependencies

```bash
apt-get install software-properties-common gnupg2 lsb-release curl -y
```

- Stable Branch

```bash
wget -O- https://repo.powerdns.com/FD380FBB-pub.asc | gpg --dearmor > /etc/apt/trusted.gpg.d/pdns_stable.gpg
```

- Set some variables for repository setup

```bash
systemReleaseVersion=$(lsb_release -cs)
osLabel=$(lsb_release -sa 2>/dev/null|head -n 1|tr '[:upper:]' '[:lower:]')
```

- Create a Working Directory for the installation

```bash
mkdir -p /opt/pdns_install
workpath="/opt/pdns_install"
```

- PowerDNS Authoritative Repository

```bash
repo_pdnsAuth="deb [arch="$(dpkg --print-architecture)]" http://repo.powerdns.com/${osLabel} ${systemReleaseVersion}-auth-48 main"
echo $repo_pdnsAuth > "/etc/apt/sources.list.d/pdns-auth.list"
```

```bash
echo \
"Package: pdns-*
Pin: origin repo.powerdns.com
Pin-Priority: 600" > /etc/apt/preferences.d/pdns
```

- `en_US.UTF-8`` Locale Settings

```bash
localectl set-locale en_US.UTF-8
sed -i 's/# ko_KR.UTF-8 UTF-8/ko_KR.UTF-8 UTF-8/' /etc/locale.gen
locale-gen
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .label .label-green }
  
```bash
Generating locales (this might take a while)...
  en_US.UTF-8... done
  ko_KR.UTF-8... done
Generation complete.
```

</details>

### Postgresql (PGSQL) Install

- Add PostgreSQL Public Key

```bash
wget -O- https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor > /etc/apt/trusted.gpg.d/postgresql.gpg
```

- Add PostgreSQL Repository

```bash
echo "deb http://apt.postgresql.org/pub/repos/apt ${systemReleaseVersion}-pgdg main" > /etc/apt/sources.list.d/pgdg.list
```

- Update the package lists:

```bash
apt-get update
```

- Install the latest version of PostgreSQL.
- If you want a specific version, use 'postgresql-12' or similar instead of 'postgresql':

```bash
apt-get -y install postgresql
```

- Enable PostgreSQL Service

```bash
systemctl enable postgresql
```

- Start PostgreSQL Service

```bash
systemctl start postgresql
```

### Generating the Database

```bash
pdns_db="pdns"
pdns_db_user="pdnsadmin"
pdns_pwd="$(tr -dc A-Za-z0-9 </dev/urandom | head -c 13 ; echo '')"
pdnsadmin_salt="$(tr -dc A-Za-z0-9 </dev/urandom | head -c 32 ; echo '')"
pdns_apikey="$(tr -dc A-Za-z0-9 </dev/urandom | head -c 32 ; echo '')"

echo "pdns_db=$pdns_db" > "$workpath/db_credentials"
echo "pdns_db_user=$pdns_db_user" >> "$workpath/db_credentials"
echo "pdns_pwd=$pdns_pwd" >> "$workpath/db_credentials"
echo "pdnsadmin_salt=$pdnsadmin_salt" >> "$workpath/db_credentials"
echo "pdns_apikey=$pdns_apikey" >> "$workpath/db_credentials"
echo "workpath=$workpath" >> "$workpath/db_credentials"
echo 'systemReleaseVersion=$(lsb_release -cs)' >> "$workpath/db_credentials"
echo 'osLabel=$(lsb_release -sa 2>/dev/null|head -n 1|tr '[:upper:]' '[:lower:]')' >> "$workpath/db_credentials"
chown root:root "$workpath/db_credentials"
chmod 640 "$workpath/db_credentials"
cd "$workpath"
```

- PostgreSQL - Set this variable for stuff down the road

```bash
db_type="pgsql"
echo "db_type=$db_type" >> "$workpath/db_credentials"

echo \
"-- PowerDNS PGSQL Create DB File
CREATE USER $pdns_db_user WITH ENCRYPTED PASSWORD '$pdns_pwd';
CREATE DATABASE $pdns_db OWNER $pdns_db_user;
GRANT ALL PRIVILEGES ON DATABASE $pdns_db TO $pdns_db_user;" > "$workpath/pdns-createdb-pg.sql"
sudo -u postgres psql < "$workpath/pdns-createdb-pg.sql"
```

### Installing PowerDNS/DNSDist

- Update the package lists:

```bash
apt update
```

- For PostgreSQL

```bash
apt-get install pdns-backend-pgsql -y
```

- PowerDNS Authoritative Server

```bash
apt-get install pdns-server -y
```

- Disable systemd-resolved

```bash
systemctl disable systemd-resolved
systemctl stop systemd-resolved
```

- Populating the Database

```bash
db_config_path="/etc/powerdns/pdns.d"
```

- Define config file based on selected DB type

```bash
db_config_file="$db_config_path/g$db_type.conf"
```

```bash
current_pgsql_ver=$(psql -V|awk -F " " '{print $NF}'|awk -F "." '{print $1}')
export PGPASSWORD="$pdns_pwd"
psql -U $pdns_db_user -h 127.0.0.1 -d $pdns_db < "/usr/share/pdns-backend-$db_type/schema/schema.$db_type.sql"
unset PGPASSWORD
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .label .label-green }

```bash
su postgres
postgres@PowerDNS-admin:/opt/pdns_install$ psql
psql (16.0 (Ubuntu 16.0-1.pgdg20.04+1))
Type "help" for help.

postgres=# \l
                                                         List of databases
   Name    |   Owner   | Encoding | Locale Provider |   Collate   |    Ctype    | ICU Locale | ICU Rules |    Access privileges
-----------+-----------+----------+-----------------+-------------+-------------+------------+-----------+-------------------------
 pdns      | pdnsadmin | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | =Tc/pdnsadmin          +
           |           |          |                 |             |             |            |           | pdnsadmin=CTc/pdnsadmin
 postgres  | postgres  | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           |
 template0 | postgres  | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | =c/postgres            +
           |           |          |                 |             |             |            |           | postgres=CTc/postgres
 template1 | postgres  | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |            |           | =c/postgres            +
           |           |          |                 |             |             |            |           | postgres=CTc/postgres
(4 rows)

postgres=# \c pdns
You are now connected to database "pdns" as user "postgres".
pdns=# \d         
                   List of relations
 Schema |         Name          |   Type   |   Owner
--------+-----------------------+----------+-----------
 public | comments              | table    | pdnsadmin
 public | comments_id_seq       | sequence | pdnsadmin
 public | cryptokeys            | table    | pdnsadmin
 public | cryptokeys_id_seq     | sequence | pdnsadmin
 public | domainmetadata        | table    | pdnsadmin
 public | domainmetadata_id_seq | sequence | pdnsadmin
 public | domains               | table    | pdnsadmin
 public | domains_id_seq        | sequence | pdnsadmin
 public | records               | table    | pdnsadmin
 public | records_id_seq        | sequence | pdnsadmin
 public | supermasters          | table    | pdnsadmin
 public | tsigkeys              | table    | pdnsadmin
 public | tsigkeys_id_seq       | sequence | pdnsadmin
(13 rows)

pdns=# \q
postgres@PowerDNS-admin:/opt/pdns_install$ exit
exit
```

</details>

- Copy the example config file

```bash
cp /usr/share/doc/pdns-backend-$db_type/examples/g$db_type.conf /etc/powerdns/pdns.d/
```

- Change the values in your PowerDNS Config file to match your saved credentials

```bash
sed -i "s/\(^g$db_type-dbname=\).*/\1$pdns_db/" "$db_config_file"
sed -i "s/\(^g$db_type-host=\).*/\1127.0.0.1/" "$db_config_file"
sed -i "s/\(^g$db_type-port=\).*/\15432/" "$db_config_file"
sed -i "s/\(^g$db_type-user=\).*/\1$pdns_db_user/" "$db_config_file"
sed -i "s/\(^g$db_type-password=\).*/\1$pdns_pwd/" "$db_config_file"
chmod 640 "$db_config_file"
chown root:pdns "$db_config_file"
```

- Restart PostgreSQL Service

```bash
systemctl restart postgresql
```

- Enable PostgreSQL Service

```bash
systemctl enable postgresql
```

```bash
sed -e "s/\(^api=\).*/\1yes/" /etc/powerdns/pdns.conf
sed -e "s/\(^api=\).*/\1$pdns_apikey/" /etc/powerdns/pdns.conf
```

- Restart pdns Service

```bash
systemctl restart pdns.service
```

```bash
dig google.com @192.168.0.40
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .label .label-green }
  
```bash
; <<>> DiG 9.16.1-Ubuntu <<>> google.com @192.168.0.40
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: REFUSED, id: 53684
;; flags: qr rd; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1
;; WARNING: recursion requested but not available

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;google.com.                    IN      A

;; Query time: 0 msec
;; SERVER: 192.168.0.40#53(192.168.0.40)
;; WHEN: Wed Oct 25 23:51:48 KST 2023
;; MSG SIZE  rcvd: 39
```

</details>
