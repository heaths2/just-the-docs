---
layout: default
title: Xen Hypervisor 설치
parent: Blog
grand_parent: Category
permalink: docs/category/blog/30
child_nav_order: desc
---
# Xen Hypervisor
{: .no_toc}

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

개요

> - 젠 하이퍼바이저(Xen Hypervisor)를 설치한다.
> [Ubuntu Code name](https://wiki.ubuntu.com/Releases)
{: .new }

### Xen Hypervisor Installed

- `/etc/netplan/00-installer-config.yaml` **Network 설정**

<details markdown="block">
  <summary>
  *NIC 설정*
  </summary>
  {: .text-delta }
```bash
tee /etc/netplan/00-installer-config.yaml << EOF
# This is the network config written by 'subiquity'
network:
  version: 2
  ethernets:
    enp0s3:
      dhcp4: false
      optional: true
    enp0s8:
      dhcp4: false
      optional: true
  bonds:
    bond0:
      dhcp4: false
      optional: true
      interfaces: [ enp0s3 ]
      parameters:
        mode: active-backup
        mii-monitor-interval: 100
        primary: enp0s3
    bond1:
      dhcp4: false
      optional: true
      interfaces: [ enp0s8 ]
      parameters:
        mode: active-backup
        mii-monitor-interval: 100
        primary: enp0s8
  bridges:
    xenbr0:
      dhcp4: false
      optional: true
      interfaces: [ bond0 ]
    xenbr1:
      dhcp4: false
      optional: true
      interfaces: [ bond1 ]
      addresses: [ 192.168.56.101/24 ]
      gateway4: 192.168.56.2     
      nameservers:
        addresses: [ 1.1.1.1, 8.8.8.8 ]
        search: [ in.infra ]
  version: 2
EOF
```
</details>
  
- Xen utils 설치

```bash
apt-get install xen-utils-4.11 -y

# Ubuntu 20.04, 22.04 image를 위해 xen-tools_4.9 설치
wget -O ./xen-tools_4.9.2-1_all.deb http://kr.archive.ubuntu.com/ubuntu/pool/universe/x/xen-tools/xen-tools_4.9.2-1_all.deb

apt-get install -y ./xen-tools_4.9.2-1_all.deb
```

- Xen grub 활성화

```bash
sed -i 's/#XEN_OVERRIDE_GRUB_DEFAULT=.*/XEN_OVERRIDE_GRUB_DEFAULT=1/' /etc/default/grub.d/xen.cfg
```

> - `/etc/default/grub.d/xen.cfg` 은 Xen 하이퍼바이저가 설치된 시스템에서 GRUB 부트 로더를 통해 부팅할 때, 기본적으로 Xen을 부팅하도록 설정하는 것을 의미
>
```bash
XEN_OVERRIDE_GRUB_DEFAULT=1
```
> 
{: .important}

- `/etc/default/grub.d/xen.cfg` Xen Hypervisor 고정 옵션 설정

```bash
sed -i 's/#GRUB_CMDLINE_XEN_DEFAULT=.*/GRUB_CMDLINE_XEN_DEFAULT="dom0_mem=2G,max:4G dom0_max_vcpus=1-2 dom0_vcpus_pin iommu=1 msi=1 pci_pt_e820_access=on watchdog ucode=scan crashkernel=256M,below=4G console=vga vga=mode-0x0311"/' /etc/default/grub.d/xen.cfg
sed -i 's/#GRUB_CMDLINE_XEN=.*/GRUB_CMDLINE_XEN=""/' /etc/default/grub.d/xen.cfg
```

>
```bash
GRUB_CMDLINE_XEN_DEFAULT="dom0_mem=1G,max:4G dom0_max_vcpus=1-2 dom0_vcpus_pin iommu=1 msi=1 pci_pt_e820_access=on watchdog ucode=scan crashkernel=256M,below=4G console=vga vga=mode-0x0311"
GRUB_CMDLINE_XEN="dom0_mem=1G,max:4G dom0_max_vcpus=1-2 dom0_vcpus_pin iommu=1 msi=1 pci_pt_e820_access=on watchdog ucode=scan crashkernel=256M,below=4G console=vga vga=mode-0x0311"
```
>
{: .important}


- grub 업데이트 적용

```bash
update-grub
reboot
```

- `Xen Hypervisor` 부팅을 위해 재부팅

```bash
reboot
```

> - XEN_OVERRIDE_GRUB_DEFAULT 값을 1로 설정하면 Xen에서 직접 GRUB의 기본 부트 항목을 제어할 수 있다. 이 설정을 활성화하면 Xen은 자체적으로 GRUB 설정을 관리하게 되며, Xen의 설정 파일에 있는 GRUB_DEFAULT 값을 사용하여 부팅 항목을 선택
{: .important}

> - pci_pt_e820_access=on: PCI Extended Access Mechanism을 활성화
> - quiet: 부팅 시 로그를 최소화
> - maybe-ubiquity: Ubiquity 설치 프로그램을 사용
> - dom0_mem=1G,max:1G: Domain-0의 메모리 크기를 1GB로 설정하고 > 최대 메모리 크기도 1GB로 제한
> - dom0_max_vcpus=1: Domain-0의 가상 CPU (vCPU) 수를 1개로 제한
> - dom0_vcpus_pin: Domain-0의 vCPU를 특정한 물리 CPU에 고정
> - iommu=1: IOMMU (Input-Output Memory Management Unit)를 > 활성화
> - msi=1: MSI (Message Signaled Interrupts)를 사용
{: .important}

> - GRUB_CMDLINE_LINUX_DEFAULT: 일반적인 리눅스 커널 부팅 시에 적용되는 매개변수를 정의. 이 변수는 일반적으로 모든 리눅스 커널 부팅에 적용되는 매개변수를 설정하는 데 사용
> 
> - GRUB_CMDLINE_XEN_DEFAULT: Xen 가상화 환경에서 사용되는 부트 매개변수를 정의. Xen은 독자적인 가상화 기술을 사용하며, 이 변수는 Xen 가상 머신 (domU) 및 Xen 호스트 (dom0)에 대한 부트 매개변수를 설정하는 데 사용
> 
> - GRUB_CMDLINE_LINUX: 일반적인 리눅스 설정을 정의하는 매개변수. 이 변수는 사용자가 추가적인 부트 매개변수를 정의하거나 수정할 수 있는 공간. 
> 
> - GRUB_CMDLINE_LINUX_DEFAULT와 유사한 역할을 수행하지만, 사용자 지정 설정에 특화
{: .important}


- 부팅 오류시

```bash
mv /etc/grub.d/10_linux /etc/grub.d/20_linux
mv /etc/grub.d/20_linux_xen /etc/grub.d/10_linux_xen
```

### LVM 설정

- 디스크 확인

```bash
parted --list
```

- 디스크 파티션션

```bash
parted /dev/sdb
(parted) print
(parted) mklabel gpt
(parted) mkpart primary 0 100%
Ignore/Cancel? ignore
(parted) quit
```

> **`Physical Volume` > `Volume Group` > `Logical Volume`**
{: .note}

```bash
# Physical Volume Create
pvcreate /dev/sdb1
pvdisplay
```

```bash
# Volume Group Create
vgcreate Disks /dev/sdb1
vgdisplay
```

```bash
# Logical Volume Create
lvcreate -L 20G -n hostname-disk Disks
lvcreate -L 1G -n hostname-swap Disks
lvs
```

```bash
# FileSystem Format
mkfs.ext4 /dev/Disks/hostname-disk
mkswap /dev/Disks/hostname-swap
```

### Xen VM 생성

- Xen 부트로더 다운로드 `initrd`, `vmlinuz`

```bash
# /etc/xen/netboot Directory 생성
mkdir -p /etc/xen/{auto,netboot}
# initrd.gz & vmlinuz 다운로드
# wget 다운로드 방식
wget http://archive.ubuntu.com/ubuntu/dists/focal/main/installer-amd64/current/legacy-images/netboot/xen/initrd.gz -O /root/initrd.gz
wget http://archive.ubuntu.com/ubuntu/dists/focal/main/installer-amd64/current/legacy-images/netboot/xen/vmlinuz -O /root/vmlinuz
# curl 다운로드 방식
curl http://archive.ubuntu.com/ubuntu/dists/focal/main/installer-amd64/current/legacy-images/netboot/xen/initrd.gz -o /root/initrd.gz
curl http://archive.ubuntu.com/ubuntu/dists/focal/main/installer-amd64/current/legacy-images/netboot/xen/vmlinuz -o /root/vmlinuz
```

> - [**initrd.gz**](http://archive.ubuntu.com/ubuntu/dists/focal/main/installer-amd64/current/legacy-images/netboot/xen/initrd.gz) 참고사이트
> - [**vmlinuz**](http://archive.ubuntu.com/ubuntu/dists/focal/main/installer-amd64/current/legacy-images/netboot/xen/vmlinuz) 참고사이트
{: .important}

```bash
# Xen 설정 파일 복사 및 설정
cp -a /etc/xen/xlexample.pvlinux /etc/xen/hostname
vi /etc/xen/hostname.cfg
```

<details markdown="block">
  <summary>
- master01.cfg 예시
  </summary>
  {: .text-delta }
```bash
#

# Configuration file for the Xen instance master01, created
# by xen-tools 4.9.2 on Wed Apr 26 07:50:44 2023.
#

#
#  Kernel + memory size
#


bootloader  = 'pygrub'
extra       = 'root=/dev/xvda1 iommu=soft'

cpus        = [ '2-34' ]
vcpus       = '34'
memory      = '57344'
maxmem      = '57344'


#
#  Disk device(s).
#
root        = '/dev/xvda1 ro'
disk        = [
                  'phy:/dev/Disks/master01-disk,xvda1,w',
                  'phy:/dev/Disks/master01-swap,xvda2,w',
              ]


#
#  Physical volumes
#


#
#  Hostname
#
name        = 'master01'

#
#  Networking
#
```
</details>

### Xen Guest VM 시작

```bash
# `-c` 옵션 console
xl create -c /etc/xen/hostname.cfg
```

### Xen Guest VM 목록 확인

```bash
xl list
```

- 특정 커널 `xen-create-image`적용

```bash
# kernel 다운로드
apt-get install -d -y linux-image-5.4.0-80-generic
dpkg-deb -x /var/cache/apt/archives/linux-image-5.4.0-80-generic_5.4.0-80.90_amd64.deb /tmp/
cp /tmp/boot/vmlinuz-5.4.0-80-generic /boot
```

- `xen-create-image` 로 이미지 생성성

```bash
xen-create-image    --hostname=ansible-master \
                    --dist=jammy \
                    --kernel=/boot/vmlinuz-5.15.0-80-generic \
                    --memory=4G \
                    --maxmem=10G \
                    --vcpus=28 \
                    --bridge=xenbr1 \
                    --vifname=vif10.1 \
                    --ip=10.1.220.100 \
                    --netmask=255.255.0.0 \
                    --gateway=10.1.255.1 \
                    --nameserver=8.8.8.8 \
                    --size=50G \
                    --swap=1G \
                    --lvm=Disks \
                    --force \
                    --pygrub \
                    --password=mail1234 \
                    --extension=
```

```bash
# --dist=arguments
# Ubuntu code name

# Ubuntu 22.04
xen-create-image    --hostname=ansible-node01 \
                    --dist=jammy \
                    --kernel=/boot/vmlinuz-5.15.0-80-generic \
                    --memory=4G --maxmem=10G \
                    --vcpus=28 \
                    --bridge=xenbr1 \
                    --vifname=vif11.1 \
                    --ip=10.1.220.101 \
                    --netmask=255.255.0.0 \
                    --gateway=10.1.255.1 \
                    --nameserver=8.8.8.8 \
                    --swap=1G \
                    --size=50G \
                    --lvm=Disks \
                    --force \
                    --pygrub \
                    --password=mail1234 \
                    --extension=

# Ubuntu 20.04
xen-create-image    --hostname=ansible-node02 \
                    --dist=focal \
                    --kernel=/boot/vmlinuz-5.4.0-80-generic \
                    --memory=4G \
                    --maxmem=10G \
                    --vcpus=34 \
                    --bridge=xenbr1 \
                    --vifname=vif12.1 \
                    --ip=10.1.220.102 \
                    --netmask=255.255.0.0 \
                    --gateway=10.1.255.1 \
                    --nameserver=8.8.8.8 \
                    --size=300G \
                    --swap=1G \
                    --lvm=Disks \
                    --force \
                    --pygrub \
                    --password=mail1234 \
                    --extension=                 
```

### 기타 설정

- `bash_completion` 자동 완성 설정

```bash
# bash_completion Apply
source /usr/share/bash-completion/bash_completion
```

- `kernel` 업그레이드 hold

```bash
# Mark some packages as "hold"
apt-mark hold linux-image-generic linux-headers-generic
apt-mark showhold
```

### Xen VM 이미지 복제

```bash
# 원본 sv01-disk 복제 sv02-disk
dd if=/dev/Disks/sv01-disk of=/dev/Disks/sv02-disk bs=4M oflag=direct conv=fsync status=progress
# 원격 복제
dd if=/dev/Disks/sv01-disk bs=8M oflag=direct conv=fsync status=progress | gzip -c -9 | ssh 10.1.1.1 'gzip -d | dd of=/dev/Disks/sv02-disk bs=5M'
```
