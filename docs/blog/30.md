---
layout: default
title: Xen Hypervisor 설치
parent: Blog
grand_parent: Category
permalink: docs/category/blog/30
child_nav_order: desc
---

개요

> - 젠 하이퍼바이저(Xen Hypervisor)를 설치한다.
> [Ubuntu Code name](https://wiki.ubuntu.com/Releases)
{: .new }

Xen Hypervisor Installed

**Network 설정**

```bash
# This is the network config written by 'subiquity'
network:
  version: 2
  ethernets:
    enp0s3:
      dhcp4: false
      optional: true
    enp0s8:
      dhcp4: false
      optional: true
  bonds:
    bond0:
      interfaces: [ enp0s3 ]
      parameters:
        mode: 802.3ad
        lacp-rate: fast
        mii-monitor-interval: 100
    bond1:
      interfaces: [ enp0s8 ]
      parameters:
        mode: 802.3ad
        lacp-rate: fast
        mii-monitor-interval: 100
  bridges:
    xenbr0:
      interfaces: [ bond0 ]
      dhcp4: false
      optional: true
      addresses: [10.0.2.16/24]
      gateway4: 10.0.2.2
    xenbr1:
      interfaces: [ bond1 ]
      dhcp4: false
      optional: true
      addresses: [ 192.168.56.101/24 ]
```

> #### Xen Utility 설정

```bash
apt-get install xen-utils -y

# Ubuntu 20.04, 22.04 image를 위해 xen-tools_4.9 설치
wget -O ./xen-tools_4.9.2-1_all.deb http://kr.archive.ubuntu.com/ubuntu/pool/universe/x/xen-tools/xen-tools_4.9.2-1_all.deb

apt-get install -y ./xen-tools_4.9.2-1_all.deb

# Xen Grub 설정 추가
vi /etc/default/grub.d/xen.cfg
```

- 수정전

```bash
#XEN_OVERRIDE_GRUB_DEFAULT=
```

- 수정후

```bash
XEN_OVERRIDE_GRUB_DEFAULT=1
```
> - XEN_OVERRIDE_GRUB_DEFAULT 값을 1로 설정하면 Xen에서 직접 GRUB의 기본 부트 항목을 제어할 수 있다. 이 설정을 활성화하면 Xen은 자체적으로 GRUB 설정을 관리하게 되며, Xen의 설정 파일에 있는 GRUB_DEFAULT 값을 사용하여 부팅 항목을 선택
{: .important}


> #### Grub 설정파일 수정
```bash
# Grub 파일 수정
vi /etc/default/grub
```

> - pci_pt_e820_access=on: PCI Extended Access Mechanism을 활성화
> - quiet: 부팅 시 로그를 최소화
> - maybe-ubiquity: Ubiquity 설치 프로그램을 사용
> - dom0_mem=1G,max:1G: Domain-0의 메모리 크기를 1GB로 설정하고 > 최대 메모리 크기도 1GB로 제한
> - dom0_max_vcpus=1: Domain-0의 가상 CPU (vCPU) 수를 1개로 제한
> - dom0_vcpus_pin: Domain-0의 vCPU를 특정한 물리 CPU에 고정
> - iommu=1: IOMMU (Input-Output Memory Management Unit)를 > 활성화
> - msi=1: MSI (Message Signaled Interrupts)를 사용
{: .important}

- 수정전

```bash
GRUB_DEFAULT=0
GRUB_TIMEOUT_STYLE=hidden
GRUB_TIMEOUT=0
GRUB_DISTRIBUTOR=`lsb_release -i -s 2> /dev/null || echo Debian`
GRUB_CMDLINE_LINUX_DEFAULT="maybe-ubiquity"
GRUB_CMDLINE_LINUX=""
```

- 수정후

```bash
GRUB_DEFAULT=0
GRUB_TIMEOUT_STYLE=hidden
GRUB_TIMEOUT=0
GRUB_DISTRIBUTOR=`lsb_release -i -s 2> /dev/null || echo Debian`
#GRUB_CMDLINE_LINUX_DEFAULT="maybe-ubiquity"
#GRUB_CMDLINE_LINUX=""
GRUB_CMDLINE_XEN_DEFAULT="dom0_mem=3G,max:16G dom0_max_vcpus=1-2 dom0_vcpus_pin iommu=1 msi=1 pci_pt_e820_access=on quiet splash"
GRUB_CMDLINE_XEN=""
```

> - GRUB_CMDLINE_LINUX_DEFAULT: 일반적인 리눅스 커널 부팅 시에 적용되는 매개변수를 정의. 이 변수는 일반적으로 모든 리눅스 커널 부팅에 적용되는 매개변수를 설정하는 데 사용
> 
> - GRUB_CMDLINE_XEN_DEFAULT: Xen 가상화 환경에서 사용되는 부트 매개변수를 정의. Xen은 독자적인 가상화 기술을 사용하며, 이 변수는 Xen 가상 머신 (domU) 및 Xen 호스트 (dom0)에 대한 부트 매개변수를 설정하는 데 사용
> 
> - GRUB_CMDLINE_LINUX: 일반적인 리눅스 설정을 정의하는 매개변수. 이 변수는 사용자가 추가적인 부트 매개변수를 정의하거나 수정할 수 있는 공간. 
> 
> - GRUB_CMDLINE_LINUX_DEFAULT와 유사한 역할을 수행하지만, 사용자 지정 설정에 특화
{: .important}


```bash
# 부팅 오류시
mv /etc/grub.d/10_linux /etc/grub.d/20_linux
mv /etc/grub.d/20_linux_xen /etc/grub.d/10_linux_xen

# Grub 파일 업데이트 적용 및 재부팅
update-grub
reboot
```

![IMG-006](https://user-images.githubusercontent.com/36792594/183536425-fef14be6-9390-4b7c-85fd-41e3f43892a3.png)

LVM 설정

```bash
parted --list
```

![IMG-007](https://user-images.githubusercontent.com/36792594/183372804-3960c46f-b885-4981-89d1-84e7355e1940.png)

```bash
parted /dev/sdb
(parted) print
(parted) mklabel gpt
(parted) mkpart primary 0 100%
Ignore/Cancel? ignore
(parted) quit
```

![IMG-008](https://user-images.githubusercontent.com/36792594/183372815-541d5c7c-62d9-4b0f-b775-85ccff8dae17.png)

**`Physical Volume` > `Volume Group` > `Logical Volume`**
{: .note}

```bash
# Physical Volume Create
pvcreate /dev/sdb1
pvdisplay
```

![IMG-009](https://user-images.githubusercontent.com/36792594/183379107-c523af84-c9fa-4b92-80a6-84ee94e141fc.png)

```bash
# Volume Group Create
vgcreate Disks /dev/sdb1
vgdisplay
```

![IMG-010](https://user-images.githubusercontent.com/36792594/183378612-96f855ad-d7c7-4968-af9d-1f39fb0e39ab.png)

```bash
# Logical Volume Create
lvcreate -L 20G -n hostname-disk Disks
lvcreate -L 1G -n hostname-swap Disks
lvs
```

![IMG-011](https://user-images.githubusercontent.com/36792594/183378600-bea3b6bb-1fb6-4a50-8462-a5d65f9f4b96.png)

```bash
# FileSystem Format
mkfs.ext4 /dev/Disks/hostname-disk
mkswap /dev/Disks/hostname-swap
```

![IMG-012](https://user-images.githubusercontent.com/36792594/183374197-c2e8a622-de67-4a6b-9e1c-ed34b1690145.png)

Xen 설치

Xen 다운로드

```bash
# /etc/xen/netboot Directory 생성
mkdir -p /etc/xen/{auto,netboot}
# initrd.gz & vmlinuz 다운로드
# wget 다운로드 방식
wget http://archive.ubuntu.com/ubuntu/dists/focal/main/installer-amd64/current/legacy-images/netboot/xen/initrd.gz -O /root/initrd.gz
wget http://archive.ubuntu.com/ubuntu/dists/focal/main/installer-amd64/current/legacy-images/netboot/xen/vmlinuz -O /root/vmlinuz
# curl 다운로드 방식
curl http://archive.ubuntu.com/ubuntu/dists/focal/main/installer-amd64/current/legacy-images/netboot/xen/initrd.gz -o /root/initrd.gz
curl http://archive.ubuntu.com/ubuntu/dists/focal/main/installer-amd64/current/legacy-images/netboot/xen/vmlinuz -o /root/vmlinuz
```

- [**initrd.gz**](http://archive.ubuntu.com/ubuntu/dists/focal/main/installer-amd64/current/legacy-images/netboot/xen/initrd.gz) 참고사이트
- [**vmlinuz**](http://archive.ubuntu.com/ubuntu/dists/focal/main/installer-amd64/current/legacy-images/netboot/xen/vmlinuz) 참고사이트

![IMG-013](https://user-images.githubusercontent.com/36792594/183536859-b5fbfa94-0871-4ddb-b165-4bc992e4019d.png)

```bash
# Xen 설정 파일 복사 및 설정
cp -a /etc/xen/xlexample.pvlinux /etc/xen/hostname
vi /etc/xen/hostname.cfg
```

- 수정전

```bash
# Guest name
name = "example.pvlinux"
# Kernel image to boot
kernel = "/boot/vmlinuz"
# Ramdisk (optional)
#ramdisk = "/boot/initrd.gz"
# Kernel command line options
extra = "root=/dev/xvda1"
# Initial memory allocation (MB)
memory = 128
# Number of VCPUS
vcpus = 2
# Network devices
vif = [ '' ]
# Disk Devices
disk = [ '/dev/vg/guest-volume,raw,xvda,rw' ]
```

![IMG-014](https://user-images.githubusercontent.com/36792594/183537010-12e4a56e-998e-494c-8cce-748954a3a1b8.png)

- 수정후

```bash
# Guest name
name = "ubuntu1"
# Kernel image to boot
kernel = "/etc/xen/netboot/vmlinuz"
# Ramdisk (optional)
ramdisk = "/etc/xen/netboot/initrd.gz"
# Kernel command line options
extra = "root=/dev/xvda1"
# Initial memory allocation (MB)
memory = 1024
# Number of VCPUS
vcpus = 2
# Network devices
vif = [ 'bridge=xenbr0' ]
# Disk Devices
disk = [ 'phy:/dev/Disks/hostname-disk,xvda1,rw','phy:/dev/Disks/hostname_swap,xvdb1,rw' ]
```

![IMG-015](https://user-images.githubusercontent.com/36792594/183537015-3481bdf0-ff59-4ee5-9f85-010f05caa20e.png)

```bash
xl list
# Xen Guest OS 설치
xl create -c /etc/xen/hostname.cfg
```

![IMG-016](https://user-images.githubusercontent.com/36792594/183559734-3310aaa8-94dd-4c44-92b1-84be676cf667.png)
![Img-017](https://user-images.githubusercontent.com/36792594/183336828-4b3c85dd-72ba-4149-a073-019f9c9f00a0.png)
![Img-018](https://user-images.githubusercontent.com/36792594/183336830-541e41f0-ea0d-42b2-9565-840870051ebe.png)
![Img-019](https://user-images.githubusercontent.com/36792594/183336832-38bfb459-7301-4fb9-9c9b-a6b9154d6a0a.png)
![Img-020](https://user-images.githubusercontent.com/36792594/183336834-6b89fd3e-f934-4fe1-b85f-4d3c789e9833.png)
![Img-021](https://user-images.githubusercontent.com/36792594/183336838-9766ea52-1fcf-41b4-9b88-e2b31fc73ac6.png)
![Img-022](https://user-images.githubusercontent.com/36792594/183336841-a783ccf0-8371-418a-86d3-bf9443665663.png)
![Img-023](https://user-images.githubusercontent.com/36792594/183336843-d1c4031e-a589-4f84-983a-426c2e19d848.png)
![Img-024](https://user-images.githubusercontent.com/36792594/183336847-152a7642-f8a4-40c6-a815-7406e9f93550.png)
![Img-025](https://user-images.githubusercontent.com/36792594/183336849-f16f99ab-5d61-4dbd-9919-6809405461e6.png)
![Img-026](https://user-images.githubusercontent.com/36792594/183336852-08b89252-7cf0-4bc1-a75d-9ace0f4fd546.png)
![Img-027](https://user-images.githubusercontent.com/36792594/183336856-93b1b870-8c49-4e46-a454-f4fc15dc831a.png)
![Img-028](https://user-images.githubusercontent.com/36792594/183336860-91c46abc-2c3a-4973-a1d2-e5ad47cdc8aa.png)
![Img-029](https://user-images.githubusercontent.com/36792594/183336861-55c94185-a2fb-4d74-963b-c6ca01191c88.png)
![Img-030](https://user-images.githubusercontent.com/36792594/183336864-92c0247d-2245-4485-bb50-64611421e900.png)
![Img-031](https://user-images.githubusercontent.com/36792594/183336866-7ac4a955-9f77-407f-af52-6828b9b984e6.png)
![Img-032](https://user-images.githubusercontent.com/36792594/183337278-94ba05ac-92f0-4847-9c7d-b1c7fa11e320.png)
![IMG-033](https://user-images.githubusercontent.com/36792594/183561901-a2ac6417-6d94-4a12-8c2b-af367fa8001a.png)
![IMG-034](https://user-images.githubusercontent.com/36792594/183560963-43518d68-c9e8-42e1-89ff-4a1b9f4bf416.png)
![IMG-035](https://user-images.githubusercontent.com/36792594/183561689-46bfda79-7f88-4dd3-a904-bb3e5d6a9d5a.png)
![Img-036](https://user-images.githubusercontent.com/36792594/183337209-8d732526-8230-4968-a7dc-1d9a571db56b.png)
![IMG-037](https://user-images.githubusercontent.com/36792594/183562284-53a95053-a628-4a96-9356-24a304ae1ef0.png)
![IMG-038](https://user-images.githubusercontent.com/36792594/183562435-a342b390-666e-40bc-ace1-304eb492f54e.png)
![IMG-039](https://user-images.githubusercontent.com/36792594/183562490-5122cbc5-3159-4193-a72b-ed7c2bc57155.png)
![IMG-040](https://user-images.githubusercontent.com/36792594/183562648-0682fb2c-c0ec-4d05-86ef-19ed1de7ac64.png)
![IMG-041](https://user-images.githubusercontent.com/36792594/183562922-f5efd062-ebd7-4cd9-9dca-04d027497ecd.png)
![IMG-042](https://user-images.githubusercontent.com/36792594/183562918-d9b5a2e0-f249-4954-be42-b01e34e87c4d.png)
![Img-043](https://user-images.githubusercontent.com/36792594/183337533-b9906fb6-ec55-4231-b440-4e20277d1500.png)
![Img-044](https://user-images.githubusercontent.com/36792594/183337535-b1171822-bc72-4435-9c23-261ba854483f.png)
![Img-045](https://user-images.githubusercontent.com/36792594/183337539-3ab0de9e-8090-48e3-aaed-555101e5b7a6.png)
![Img-046](https://user-images.githubusercontent.com/36792594/183337541-7063177d-bec0-4a83-89fb-d3f6d0cddf11.png)
![Img-047](https://user-images.githubusercontent.com/36792594/183337546-9cad4bd1-5200-4606-8091-c75da148b785.png)
![Img-048](https://user-images.githubusercontent.com/36792594/183337548-a325d450-d5b1-4f09-bb57-08c05187cc7b.png)
![Img-049](https://user-images.githubusercontent.com/36792594/183337527-98d036f8-a5b0-44e8-ac23-61762aab3b19.png)
![Img-050](https://user-images.githubusercontent.com/36792594/183337530-567a161d-e24e-4ef5-9899-405f2d5195f3.png)
![Img-051](https://user-images.githubusercontent.com/36792594/183337531-8828e74b-f05e-412a-ad36-69c656be3034.png)
![IMG-052](https://user-images.githubusercontent.com/36792594/183568841-7ad0fcff-edab-4f53-aa23-7f2fbf9dfff4.png)

```bash
vi /etc/xen/ubuntu1.cfg
# Kernel image to boot 주석
#kernel = "/etc/xen/netboot/vmlinuz"
# Ramdisk (optional) 주석
#ramdisk = "/etc/xen/netboot/initrd.gz"
# Bootloader 추가
bootloader = "/usr/lib/xen-4.11/bin/pygrub"
```

![IMG-053](https://user-images.githubusercontent.com/36792594/183569340-ce92523f-bddf-44d5-b626-6bc9e25e45b0.png)

```bash
# 마운트 후 Guest OS 정상 설치 확인
mkdir -p /mnt/ubuntu1/
mount /dev/Disks/hostname-disk /mnt/hostname/
ls -al /mnt/ubuntu1/
```

![Img-054](https://user-images.githubusercontent.com/36792594/183339635-c7b55c02-734b-442e-882d-0e6b85e55112.png)

```bash
# Guest OS 부팅
xl create -c /etc/xen/hostname.cfg
```

![Img-055](https://user-images.githubusercontent.com/36792594/183338731-f6ca7a06-f249-4a5e-a9a1-7d42c7d5068a.png)

```bash
# kernel 다운로드
apt-get install -d -y linux-image-5.4.0-80-generic
dpkg-deb -x /var/cache/apt/archives/linux-image-5.4.0-80-generic_5.4.0-80.90_amd64.deb /tmp/
cp /tmp/boot/vmlinuz-5.4.0-80-generic /boot
```

```bash
xen-create-image    --hostname=ansible-master \
                    --dist=jammy \
                    --kernel=/boot/vmlinuz-5.15.0-80-generic \
                    --memory=4G \
                    --maxmem=10G \
                    --vcpus=28 \
                    --bridge=xenbr1 \
                    --vifname=vif10.1 \
                    --ip=10.1.220.100 \
                    --netmask=255.255.0.0 \
                    --gateway=10.1.255.1 \
                    --nameserver=8.8.8.8 \
                    --size=50G \
                    --swap=1G \
                    --lvm=Disks \
                    --force \
                    --pygrub \
                    --password=mail1234 \
                    --extension=
```

```bash
# --dist=arguments
# Ubuntu code name

# Ubuntu 22.04
xen-create-image    --hostname=ansible-node01 \
                    --dist=jammy \
                    --kernel=/boot/vmlinuz-5.15.0-80-generic \
                    --memory=4G --maxmem=10G \
                    --vcpus=28 \
                    --bridge=xenbr1 \
                    --vifname=vif11.1 \
                    --ip=10.1.220.101 \
                    --netmask=255.255.0.0 \
                    --gateway=10.1.255.1 \
                    --nameserver=8.8.8.8 \
                    --swap=1G \
                    --size=50G \
                    --lvm=Disks \
                    --force \
                    --pygrub \
                    --password=mail1234 \
                    --extension=

# Ubuntu 20.04
xen-create-image    --hostname=ansible-node02 \
                    --dist=focal \
                    --kernel=/boot/vmlinuz-5.4.0-80-generic \
                    --memory=4G \
                    --maxmem=10G \
                    --vcpus=34 \
                    --bridge=xenbr1 \
                    --vifname=vif12.1 \
                    --ip=10.1.220.102 \
                    --netmask=255.255.0.0 \
                    --gateway=10.1.255.1 \
                    --nameserver=8.8.8.8 \
                    --size=300G \
                    --swap=1G \
                    --lvm=Disks \
                    --force \
                    --pygrub \
                    --password=mail1234 \
                    --extension=                 
```

#### master01.cfg 예시

```bash
#                                                                                                                                                                                   [0/261]
# Configuration file for the Xen instance master01, created
# by xen-tools 4.9.2 on Wed Apr 26 07:50:44 2023.
#

#
#  Kernel + memory size
#


bootloader  = 'pygrub'
extra       = 'root=/dev/xvda1 iommu=soft'

cpus        = [ '2-34' ]
vcpus       = '34'
memory      = '57344'
maxmem      = '57344'


#
#  Disk device(s).
#
root        = '/dev/xvda1 ro'
disk        = [
                  'phy:/dev/Disks/master01-disk,xvda1,w',
                  'phy:/dev/Disks/master01-swap,xvda2,w',
              ]


#
#  Physical volumes
#


#
#  Hostname
#
name        = 'master01'

#
#  Networking
#
```

### 초기 설치 패키지

```bash
#!/bin/bash

# Install necessary packages
apt-get update
apt-get install -y ansible bash-completion curl dnsutils git htop ifenslave iftop net-tools man nfs-common nscd ntp psmisc rsync screen software-properties-common sysstat tcpdump tcpflow tmux traceroute tree vim vim-gtk wget

# bash_completion Apply
source /usr/share/bash-completion/bash_completion

# Mark some packages as "hold"
apt-mark hold linux-image-generic linux-headers-generic
apt-mark showhold
```

### Clone a Xen VM image

```bash
# 원본 sv01-disk 복제 sv02-disk
dd if=/dev/Disks/sv01-disk of=/dev/Disks/sv02-disk bs=4M oflag=direct conv=fsync status=progress
# 원격 복제
dd if=/dev/Disks/sv01-disk bs=8M oflag=direct conv=fsync status=progress | gzip -c -9 | ssh 10.1.1.1 'gzip -d | dd of=/dev/Disks/sv02-disk bs=5M'
```
