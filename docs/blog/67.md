---
layout: default
title: Ansible
parent: Blog
grand_parent: Category
permalink: docs/category/blog/67
child_nav_order: desc
---
# Ansible
{: .no_toc}

## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}

---
## 개요

> - Ansible
> - [멱등성](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_intro.html)
> - [Ansible](https://docs.ansible.com/ansible/latest/index.html) doc
{: .new }

### Ansible Installing

```bash
sudo apt update
sudo apt install software-properties-common
sudo add-apt-repository --yes --update ppa:ansible/ansible
sudo apt install ansible
```

{: .important-title }
> ssh key [yes] skip
> ```bash
> vi /etc/ansible/ansible.cfg
>
> cat <<-EOF >> /etc/ansible/ansible.cfg
> host_key_checking = False
> EOF
> # OR
> export ANSIBLE_HOST_KEY_CHECKING=False
> ```
> [host key doc](https://docs.ansible.com/ansible/latest/inventory_guide/connection_details.html)

### ansible completion

```bash
# Ansible Completion 스크립트를 다운로드합니다.
git clone https://github.com/dysosmus/ansible-completion.git /root/ansible-completion
# 스크립트를 /etc/bash_completion.d/ 디렉토리로 복사합니다.
cp /root/ansible-completion/ansible-* /etc/bash_completion.d/
# 스크립트를 로드하고 적용하기 위해 source 명령어를 사용합니다.
source /etc/bash_completion.d/ansible-completion.bash
source /etc/bash_completion.d/ansible-doc-completion.bash
source /etc/bash_completion.d/ansible-galaxy-completion.bash
source /etc/bash_completion.d/ansible-playbook-completion.bash
source /etc/bash_completion.d/ansible-pull-completion.bash
source /etc/bash_completion.d/ansible-vault-completion.bash
```

### Directory layout

```bash
mkdir -p /etc/ansible/inventories/{development,production,staging,testing}/{hosts,group_vars,host_vars} /etc/ansible/library/{module_utils,filter_plugins} /etc/ansible/roles /etc/ansible/playbooks
```


```bash
# 관리대상 host 추가
vi /etc/ansible/hosts

cat <<-EOF >> /etc/ansible/hosts
[mgmt]
localhost

[mgmt:vars]
ansible_connection=local
ansible_user=root
ansible_host=192.168.56.111

[test]
192.168.56.[101:102]
node103 ansible_host=192.168.56.103 

[test:vars]
ansible_connection=ssh
ansible_user=root
ansible_ssh_private_key_file=/root/.ssh/id_rsa.pub
ansible_ssh_pass= !vault |
          $ANSIBLE_VAULT;1.1;AES256
          35663438653062616163343564643463336230363366306366303262616332313630643139613337
          3761363261303566333666386363656231613931386362300a623638666335386664306638613439
          35663636313761633431373665343866643930663663333837373139643735353864343262656138
          3737313038613437320a326437613636343938616261323436646434636263383664623563653466
          3936
EOF
```

```bash
# 평문 패스워드를 암호화 합니다.
# ansible_ssh_pass=mail1234
ansible-vault encrypt_string --name 'ansible_password'
New Vault password: 
Confirm New Vault password: 
Reading plaintext input from stdin. (ctrl-d to end input)
mail1234
!vault |
          $ANSIBLE_VAULT;1.1;AES256
          38616165336463666234303235663131313638396537633961623663363630303632633334656665
          6361636530656463343232323063663839376662316262610a623234666132613736383032623739
          39633863616265306561316137666337326563366636613262343435636265326436623038396333
          6335303163656339660a623732373166386430656238346666396432633065363031396431653439
          3537
Encryption successful
```

```bash
# SSH Keygen 생성
ssh-keygen -t rsa -b 4096 -N "" -f /root/.ssh/id_rsa
# SSH Public Key 복사
ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.56.103
```

### AD-HOC

> 1줄 명령어 : AD-HOC
> ansible
{: .important }

```bash
# `--ssh-common-args="-o StrictHostKeyChecking=no"`

ansible all --list-hosts

ansible all -m ping -k
ansible test -m ping -k

ansible all -m ping --ssh-common-args="-o StrictHostKeyChecking=no"
ansible test -m ping --ssh-common-args="-o StrictHostKeyChecking=no"

ansible all -m shell -a "ls -al"
ansible test -m shell -a "ls -al"

# useradd
ansible all -m user -a "name=tester state=present"
ansible test -m user -a "name=tester state=present"
# userdel
ansible all -m user -a "name=tester state=absent"
ansible test -m user -a "name=tester state=absent"

# apt-get install -y vim-gtk
ansible all -m apt -a "name=vim-gtk state=present" -k
ansible test -m apt -a "name=vim-gtk state=present" -k

# yum install -y vim-gtk
ansible all -m yum -a "name=vim-gtk state=present" -k
ansible test -m yum -a "name=vim-gtk state=present" -k

# cp .bashrc ~/.bashrc
ansible all -m copy -a "src=.bashrc dest=~/.bashrc"
ansible all -m test -a "src=.bashrc dest=~/.bashrc"

# systemctl start ssh
ansible all -m service -a "name=ssh state=started"
ansible test -m service -a "name=ssh state=started"

#firewall-cmd --permanent --add-service=ssh
#firewall-cmd --reload
ansible all -m firewalld -a "service=ssh zone=public permanent=true state=enabled"
ansible test -m firewalld -a "service=ssh zone=public permanent=true state=enabled"
```

### 플레이북

> 명령어 집합 : 플레이북
> ansible-playbook
> YAML 파일의 형식
> - 공백 문자(Space)를 이용한 들여쓰기, 탭은 안됨
> - 리스트 요소를 여러 줄에 쓸 때에는 하이픈(-)으로 시작
> - 해쉬는 콜론 기호(:)를 이용해서 키:값의 형태 표현
> - 주석은 샵(#)으로 표시, 한 줄이 끝날 때까지 유효
> - 하나의 스크림에 있는 여러 개의 문서는 하이픈 3개(---)로 나누며, 마침표 3개(...)로 스크림의 끝 표시
{: .important }


### yaml 파일 사용법

```bash
ansible-playbook test.yml -k
```

### yaml 파일 문법체크

```bash
ansible-playbook --syntax-check test.yml
```

```yaml
- name: Get ping response
  ansible.builtin.ping:
```


```yaml
---
- name: Ansible ssh-keygen generation
  hosts: test
  become: true
  gather_facts: False

  tasks:
    - ansible.builtin.include_tasks:
        file: ping.yml
        
    - name: Ansible master key generation
      connection: local
      ansible.builtin.command: "echo y | ssh-keygen -t rsa -b 4096 -N '' -f /root/.ssh/id_rsa"

      # ignore_errors: True
      run_once: true

    - name: Copy Ansible master key to remote host
      ansible.posix.authorized_key:
        user: root
        state: present
        key: "{{ lookup('file', '/root/.ssh/id_rsa.pub') }}"

    - name: Ansible master read
      ansible.builtin.command: "cat ~/.ssh/id_rsa.pub"
      register: id_rsa
      run_once: true

    - name: Check if file exists
      ansible.builtin.stat:
        path: /root/.ssh/authorized_keys
      register: result

    # - name: Ansible node key Create
    #   ansible.builtin.file:
    #     path: /root/.sshauthorized_keys
    #     state: touch
    #     owner: root
    #     group: root
    #     mode: '0600'
    #     when: result.stat.exists == false
    #       - result.stat.exists == false
    #       - not result.stat.exists

    - name: Ansible node key add
      ansible.builtin.lineinfile:
        path: /root/.sshauthorized_keys
        state: absent
        regexp: 'ubuntu$'
    #     when: 
    #     - result.stat.exists == true

    # - name: Ansible node key add
    #   ansible.builtin.file:
    #     path: /root/.sshauthorized_keys
    #     state: absent
    #     when: 
    #     - result.stat.exists == true        
```

### ansible directory layout

```bash
tree

├── ansible.cfg
├── hosts
├── inventories
│   ├── development
│   │   ├── group_vars
│   │   ├── hosts
│   │   └── host_vars
│   ├── mgmt
│   │   ├── group_vars
│   │   │   └── mgnt
│   │   ├── hosts
│   │   └── host_vars
│   ├── production
│   │   ├── group_vars
│   │   ├── hosts
│   │   └── host_vars
│   ├── staging
│   │   ├── group_vars
│   │   │   └── test
│   │   ├── hosts
│   │   │   └── test.yml
│   │   └── host_vars
│   └── testing
│       ├── group_vars
│       ├── hosts
│       └── host_vars
├── library
│   ├── filter_plugins
│   └── module_utils
└── roles
    └── test
        ├── defaults
        │   ├── main.yml
        │   └── ping.yml
        ├── files
        ├── handlers
        │   └── main.yml
        ├── meta
        │   └── main.yml
        ├── README.md
        ├── tasks
        │   └── main.yml
        ├── templates
        ├── tests
        │   ├── inventory
        │   └── test.yml
        └── vars
            └── main.yml
```
