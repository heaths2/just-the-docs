---
layout: default
title: FortiGate FreeRADIUS two-factor authentication with Google Authenticator
parent: Blog
grand_parent: Category
permalink: docs/category/blog/b0147
child_nav_order: desc
---

# FortiGate FreeRADIUS two-factor authentication with Google Authenticator

<details open markdown="block">
  <summary>
    Table of contents
  </summary>
  {: .no_toc .text-delta .label .label-green }
1. TOC
{:toc}
</details>

---

## 개요

> - FortiGate FreeRADIUS two-factor authentication with Google Authenticator
> - Interworking FreeRADIUS with FortiGate
> - [FreeRADIUS Packages](https://networkradius.com/packages/#fr32-ubuntu-jammy)
{: .new }

### FreeRADIUS 구성방법

#### 필수 패키지 설치

```bash
apt update
apt-get install -y freeradius freeradius-postgresql postgresql libpam-google-authenticator
```

#### FreeRADIUS + Postgresql 설정

- PostgreSQL DATABASE 설정

```bash
sudo -u postgres psql -c "CREATE USER radius WITH PASSWORD 'qwer1234';"
sudo -u postgres psql -c "CREATE DATABASE radius;"
sudo -u postgres psql radius < /etc/freeradius/3.0/mods-config/sql/main/postgresql/schema.sql
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE nas TO radius;"
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE radacct TO radius;"
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE radcheck TO radius;"
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE radpostauth TO radius;"
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE radreply TO radius;"
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE radusergroup TO radius;"
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE radgroupcheck TO radius;"
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE radgroupreply TO radius;"
sudo -u postgres psql -d radius -c "GRANT USAGE, SELECT ON SEQUENCE radpostauth_id_seq TO radius;"
```

- SQL Data 입력

> * 평문
```bash
# 평문
sudo -u postgres psql -d radius -c "INSERT INTO radcheck (username, attribute, op, value) VALUES ('bob', 'Cleartext-Password', ':=', 'qwer1234');"
sudo -u postgres psql -d radius -c "INSERT INTO radusergroup (username, groupname, priority) VALUES ('bob', 'RadiusUsers', 1);"
```

 
> * SHA512 암호
```bash
sudo -u postgres psql -d radius -c "INSERT INTO radcheck (username, attribute, op, value) VALUES ('bob', 'SSHA2-512-Password', ':=', '{ssha512}KMIBvW92UDXfoKvkW7pL+n8mPKY831Ob0kG+LhXSpAtC+pstS9Eax5qG3q9uTpgJoyra3EzFPgTfdtGb6zbMvLlTPZGZUJBTKVTd5cKL1Oc=');"
sudo -u postgres psql -d radius -c "INSERT INTO radusergroup (username, groupname, priority) VALUES ('bob', 'RadiusUsers', 1);"
```

- SQL radcheck Tables Data 조회

```bash
sudo -u postgres psql -d radius -c "SELECT * FROM radcheck;"
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }
  
```bash
 id | username |     attribute      | op |  value   
----+----------+--------------------+----+----------
  1 | bob      | Cleartext-Password | := | qwer1234
  2 | alice    | Cleartext-Password | := | qwer1234
(2 rows)
```

</details>

- SQL radusergroup Tables Data 조회

```bash
sudo -u postgres psql -d radius -c "SELECT * FROM radusergroup;"
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }
  
```bash
 id | username |  groupname  | priority 
----+----------+-------------+----------
  1 | bob      | RadiusUsers |        1
  2 | alice    | RadiusUsers |        1
(2 rows)
```

</details>

- Python3 Hashing 알고리즘

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }

```
import hashlib
import base64
import os

def ssha2_512(password):
    salt = os.urandom(16)
    hash = hashlib.sha512(password.encode('utf-8') + salt).digest()
    return '{ssha512}' + base64.b64encode(hash + salt).decode('utf-8')

# 비밀번호를 SSHA2-512로 해싱
password = "qwer1234"
hashed_password = ssha2_512(password)

# 생성된 해시된 비밀번호 출력
print(f"SSHA2-512 hashed password for 'qwer1234': {hashed_password}")
```

</details>

#### FreeRADIUS 설정

- RADIUS 서버 인증 시도 로그 기록 설정

```bash
sed -i '349s/auth = no/auth = yes/' /etc/freeradius/3.0/radiusd.conf
sed -i '373s/auth_badpass = no/auth_badpass = yes/' /etc/freeradius/3.0/radiusd.conf
sed -i '374s/auth_goodpass = no/auth_goodpass = yes/' /etc/freeradius/3.0/radiusd.conf
sed -n '349p' /etc/freeradius/3.0/radiusd.conf
sed -n '373p' /etc/freeradius/3.0/radiusd.conf
sed -n '374p' /etc/freeradius/3.0/radiusd.conf
```

- sql, pam 심볼릭 링크 파일 생성

```bash
cd /etc/freeradius/3.0/mods-enabled
ln -s ../mods-available/sql sql
ln -s ../mods-available/pam pam
chown -h $(id -u freerad):$(id -g freerad) sql pam
```

- PostgreSQL DB 설정

```bash
sed -i -e 's/dialect = "sqlite"/dialect = "postgresql"/' \
       -e 's/driver = "rlm_sql_null"/#&/' \
       -e '/driver = "rlm_sql_${dialect}"/ s/^#//' \
       -e '/server = "localhost"/ s/^#//' \
       -e '/port = 3306/ s/^#//' \
       -e 's/port = 3306/port = 5432/' \
       -e '/login = "radius"/ s/^#//' \
       -e '/read_clients = yes/ s/^#//' \
       -e '/password = "radpass"/ s/^#//' \
       -e 's/password = "radpass"/password = "qwer1234"/' /etc/freeradius/3.0//mods-available/sql
```

- Google 2FA 등록 설정

```bash
sed -i -e '/pam/ s/^#//' \
       -e '/auth_log/ s/^#//' \
       -e '/reply_log/ s/^#//' /etc/freeradius/3.0/sites-available/default

sed -i 's/@include/#@include/g' /etc/pam.d/radiusd

echo "
# Google Authenticator 모듈을 사용한 OTP 인증
auth       required     pam_google_authenticator.so forward_pass secret=/etc/freeradius/3.0/pam.d/\${USER}/.google_authenticator user=freerad
# 시스템 사용자 계정 인증
account    required    pam_permit.so use_first_pass\
" >> /etc/pam.d/radiusd

cat /etc/pam.d/radiusd

echo "
# Instruct FreeRADIUS to use PAM to authenticate users
DEFAULT Auth-Type := PAM\
" >> /etc/freeradius/3.0/mods-config/files/authorize
sed -n '207,$p' /etc/freeradius/3.0/mods-config/files/authorize
```

- FortiGate 접속 정보 등록

```bash
echo "
client FortiGate-60E {
        ipaddr          = 10.1.0.0
        netmask         = 24
        port            = 1812
        proto           = *
        secret          = testing123
        require_message_authenticator = no
        nas_type        = other
}" >> /etc/freeradius/3.0/clients.conf
```

> - ipaddr를 지정하지 않을 경우 0.0.0.0/0 모든 IP 허용
```bash
echo "
client FortiGate-60E {
        port            = 1812
        proto           = *
        secret          = testing123
        require_message_authenticator = no
        nas_type        = other
}" >> /etc/freeradius/3.0/clients.conf
```
>
{: .important }

- *Google Authenticator 2Factor* 인증 사용시 디렉토리 권한 변경

```bash
sed -i 's/ReadOnlyDirectories=\/etc\/freeradius/#ReadOnlyDirectories=\/etc\/freeradius/' /lib/systemd/system/freeradius.service
```

- FreeRADIUS 서비스 등록 및 재시작

```bash
systemctl daemon-reload
systemctl enable --now freeradius.service
```

> - Google Authenticator 2Factor 인증키 생성 방법
```bash
google-authenticator -tdf -r 1 -Q UTF8 -R 30 -s /home/${user:-bob}/.ssh/.google_authenticator
```
>
{: .important}

- Google Authenticator 2Factor 복사

```bash
mkdir -p /etc/freeradius/3.0/pam.d/bob
cd /etc/freeradius/3.0/pam.d/bob
cp -av /home/bob/.ssh/.google_authenticator .google_authenticator
chown -R freerad:freerad /etc/freeradius/3.0/pam.d/
```

- FreeRADIUS 디버깅 활성화

```bash
freeradius -X
```

- Localhost 서버에서 RADIUS 테스트

```bash
radtest bob qwer1234 localhost 0 testing123
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }

```bash
Sent Access-Request Id 98 from 0.0.0.0:53028 to 127.0.0.1:1812 length 73
        User-Name = "bob"
        User-Password = "qwer1234557505"
        NAS-IP-Address = 10.1.1.100
        NAS-Port = 0
        Message-Authenticator = 0x00
        Cleartext-Password = "qwer1234557505"
Received Access-Accept Id 98 from 127.0.0.1:1812 to 127.0.0.1:53028 length 20
```

</details>

- Remote 서버에서 RADIUS 테스트

```bash
radtest bob qwer1234 10.1.1.100 0 testing123
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }

```bash
Sent Access-Request Id 125 from 0.0.0.0:40436 to 10.1.1.100:1812 length 73
        User-Name = "bob"
        User-Password = "qwer1234557505"
        NAS-IP-Address = 10.1.1.200
        NAS-Port = 0
        Message-Authenticator = 0x00
        Cleartext-Password = "qwer1234557505"
Received Access-Accept Id 125 from 10.1.1.100:1812 to 10.1.200.1:40436 length 20
```

</details>

- FortiGate RADIUS 서버 등록

```bash
config user radius
    edit "if-radius"
        set server "10.1.1.100"
        set secret testing123
    next
end
```

- FortiGate User Group 등록

```bash
config user group
    edit "Radius Authentication"
        set member "if-radius"
    next
end
```

- FortiGate Administrators `RadiusUsers` 계정 등록

```bash
config system admin
    edit "RadiusUsers"
        set remote-auth enable
        set accprofile "super_admin"
        set vdom "root"
        set wildcard enable
        set remote-group "Radius Authentication"
    next
end
```

- FortiGate & Test User Credentiials

```bash
diagnose test authserver radius if-radius pap bob qwer1234
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }
  
```bash
authenticate 'bob' against 'pap' succeeded, server=primary assigned_rad_session_id=1864367789 session_timeout=0 secs idle_timeout=0 secs!
```

![image](https://github.com/heaths2/heaths2.github.io/assets/36792594/dae0174a-b88f-40a1-a633-2775250840ac)

![image](https://github.com/heaths2/heaths2.github.io/assets/36792594/335631f6-25d0-45b2-ba82-f01e82d3fc5c)

</details>


- 자동 설치 스크립트

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }

```bash
#!/usr/bin/env bash
set -eE
export LC_ALL=ko_KR.UTF-8

# 로그 파일 정의
log_file="/tmp/$(basename "$0")-$(date +'%F_%H%M%S').log"

# 모든 출력을 로그 파일과 콘솔에 동시에 기록
exec &> >(tee -a "$log_file")

title() {
    echo "----- $1 -----"
}

title "필수 패키지 설치"
apt update
apt-get install -y freeradius freeradius-postgresql postgresql libpam-google-authenticator
title "필수 패키지 설치 완료"

title "PostgreSQL 설정 시작"
sudo -u postgres psql -c "CREATE USER radius WITH PASSWORD 'qwer1234';"
sudo -u postgres psql -c "CREATE DATABASE radius;"
sudo -u postgres psql radius < /etc/freeradius/3.0/mods-config/sql/main/postgresql/schema.sql
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE nas TO radius;"
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE radacct TO radius;"
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE radcheck TO radius;"
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE radpostauth TO radius;"
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE radreply TO radius;"
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE radusergroup TO radius;"
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE radgroupcheck TO radius;"
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE radgroupreply TO radius;"
sudo -u postgres psql -d radius -c "GRANT USAGE, SELECT ON SEQUENCE radpostauth_id_seq TO radius;"

sudo -u postgres psql -d radius -c "INSERT INTO radcheck (username, attribute, op, value) VALUES ('bob', 'Cleartext-Password', ':=', 'qwer1234');"
sudo -u postgres psql -d radius -c "INSERT INTO radcheck (username, attribute, op, value) VALUES ('ace', 'Cleartext-Password', ':=', 'qwer1234');"
sudo -u postgres psql -d radius -c "INSERT INTO radusergroup (username, groupname, priority) VALUES ('bob', 'RadiusUsers', 1);"
sudo -u postgres psql -d radius -c "INSERT INTO radusergroup (username, groupname, priority) VALUES ('ace', 'RadiusUsers', 1);"

sudo -u postgres psql -d radius -c "SELECT * FROM radcheck;"

sudo -u postgres psql -d radius -c "SELECT * FROM radusergroup;"
title "PostgreSQL 설정 완료"

title "FreeRADIUS 설정"
sed -i '349s/auth = no/auth = yes/' /etc/freeradius/3.0/radiusd.conf
sed -i '373s/auth_badpass = no/auth_badpass = yes/' /etc/freeradius/3.0/radiusd.conf
sed -i '374s/auth_goodpass = no/auth_goodpass = yes/' /etc/freeradius/3.0/radiusd.conf
sed -n '349p' /etc/freeradius/3.0/radiusd.conf
sed -n '373p' /etc/freeradius/3.0/radiusd.conf
sed -n '374p' /etc/freeradius/3.0/radiusd.conf

cd /etc/freeradius/3.0/mods-enabled
ln -s ../mods-available/sql sql
chown -h $(id -u freerad):$(id -g freerad) sql

sed -i -e 's/dialect = "sqlite"/dialect = "postgresql"/' \
       -e 's/driver = "rlm_sql_null"/#&/' \
       -e '/driver = "rlm_sql_${dialect}"/ s/^#//' \
       -e '/server = "localhost"/ s/^#//' \
       -e '/port = 3306/ s/^#//' \
       -e 's/port = 3306/port = 5432/' \
       -e '/login = "radius"/ s/^#//' \
       -e '/read_clients = yes/ s/^#//' \
       -e '/password = "radpass"/ s/^#//' \
       -e 's/password = "radpass"/password = "qwer1234"/' /etc/freeradius/3.0//mods-available/sql
title "FreeRADIUS 설정 완료"

title "PAM 설정"
cd /etc/freeradius/3.0/mods-enabled
ln -s ../mods-available/pam pam
chown -h $(id -u freerad):$(id -g freerad) pam
sed -i -e '/pam/ s/^#//' \
       -e '/auth_log/ s/^#//' \
       -e '/reply_log/ s/^#//' /etc/freeradius/3.0/sites-available/default
sed -i 's/@include/#@include/g' /etc/pam.d/radiusd

echo "
# Google Authenticator 모듈을 사용한 OTP 인증
auth       required     pam_google_authenticator.so forward_pass secret=/etc/freeradius/3.0/pam.d/\${USER}/.google_authenticator user=freerad
# 시스템 사용자 계정 인증
account    required    pam_permit.so use_first_pass\
" >> /etc/pam.d/radiusd

cat /etc/pam.d/radiusd

echo "
# Instruct FreeRADIUS to use PAM to authenticate users
DEFAULT Auth-Type := PAM\
" >> /etc/freeradius/3.0/mods-config/files/authorize
sed -n '207,$p' /etc/freeradius/3.0/mods-config/files/authorize
title "PAM 설정 완료"

title "클라이언트 설정"
echo "
client FortiGate-60E {
        ipaddr          = 10.1.0.0
        netmask         = 24
        port            = 1812
        proto           = *
        secret          = testing123
        require_message_authenticator = no
        nas_type        = other
}" >> /etc/freeradius/3.0/clients.conf
title "클라이언트 설정 완료"

title "ReadOnlyDirectories 설정 제거"
sed -i 's/ReadOnlyDirectories=\/etc\/freeradius/#ReadOnlyDirectories=\/etc\/freeradius/' /lib/systemd/system/freeradius.service
title "ReadOnlyDirectories 설정 제거 완료"

title "서비스 재시작"
systemctl daemon-reload &&\
systemctl enable --now freeradius.service
title "서비스 재시작 완료"

echo "
# 아래 명령어를 사용하여 bob 2FA 인증키를 발급
google-authenticator -tdf -r 1 -Q UTF8 -R 30 -s /home/${user:-bob}/.ssh/.google_authenticator

# Google Authenticator 2Factor 복사
mkdir -p /etc/freeradius/3.0/pam.d/bob
cd /etc/freeradius/3.0/pam.d/bob
cp -av /home/bob/.ssh/.google_authenticator .google_authenticator
chown -R freerad:freerad /etc/freeradius/3.0/pam.d/

# 테스트 방법
# FreeRADIUS 디버깅 활성화를 하려면 아래 명령어를 입력
freeradius -X
radtest bob qwer1234+OTP localhost 0 testing123

# 로그 확인
tail -f /var/log/auth
"
```

</details>

- 테스트 스크립트

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }

```bash
#!usr/bin/env python3
# -*- coding: utf-8 -*-

__version__ = '1.0.0'


import subprocess
import os
import sys
import logging
from datetime import datetime

def installed_packages():
    subprocess.run(['apt-get', 'update'])
    subprocess.run(['apt-get', 'install', '-y', 'ppp', 'python3-pexpect', 'python3-pyotp'])

try:
    import pexpect
    import pyotp
except ImportError as e:
    print('필요한 패키지가 설치되어 있지 않습니다. 패키지를 설치합니다...')
    installed_packages()

    import pexpect
    import pyotp


now = datetime.now().strftime('%Y%m%d_%H%M%S')
file_name = os.path.basename(sys.argv[0])
logs = f'/tmp/{file_name}-{now}.log'
logger = logging.getLogger(__name__)
logging.basicConfig(level=logging.DEBUG, encoding='utf-8', datefmt='[%Y-%m-%d %H:%M:%S]',
                    format='%(asctime)s %(name)s %(levelname)s %(message)s',
                    handlers=[
                        logging.FileHandler(logs),
                        logging.StreamHandler(sys.stdout)
                    ])

logging.info('테스트 시작')

OTP_SECRET = os.getenv('OTP_SECRET', 'OTPS_PW') # .google_authenticator 키값
SERVER = os.getenv('RADIUS_SERVER', 'localhost')
SECRET = os.getenv('RADIUS_SECRET', 'testing123')
ID = os.getenv('RADIUS_ID', 'bob')
PW = os.getenv('RADIUS_PW', 'qwer1234')
totp = pyotp.TOTP(OTP_SECRET)
current_otp = totp.now()

print(f'현재 OTP: {current_otp}')

# radtest 명령어 실행
cmd = f'radtest {ID} {PW}{current_otp} {SERVER} 0 {SECRET}'
child = pexpect.spawn(cmd, encoding='utf-8')
child.logfile = sys.stdout  # 출력 로그를 stdout에 기록

child.expect(pexpect.EOF)
child.close()

print('is alive:', child.isalive())

# 로그 파일에 추가 기록
logging.info('테스트 종료')
```

</details>
