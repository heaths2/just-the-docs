---
layout: default
title: FreeRADIUS Configure
parent: Blog
grand_parent: Category
permalink: docs/category/blog/b0147
child_nav_order: desc
---

# Interworking FreeRADIUS with FortiGate

<details open markdown="block">
  <summary>
    Table of contents
  </summary>
  {: .no_toc .text-delta .label .label-green }
1. TOC
{:toc}
</details>

---

## 개요

> - FreeRADIUS Configure
> - Interworking FreeRADIUS with FortiGate
> - [FreeRADIUS Packages](https://networkradius.com/packages/#fr32-ubuntu-jammy)
{: .new }

### FreeRADIUS 구성방법

#### 필수 패키지 설치

```bash
apt update
apt-get install -y freeradius freeradius-postgresql postgresql libpam-google-authenticator
```

#### FreeRADIUS + Postgresql 설정

- PostgreSQL DATABASE 설정

```bash
sudo -u postgres psql -c "CREATE USER radius WITH PASSWORD 'qwer1234';"
sudo -u postgres psql -c "CREATE DATABASE radius;"
sudo -u postgres psql radius < /etc/freeradius/3.0/mods-config/sql/main/postgresql/schema.sql
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE nas TO radius;"
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE radacct TO radius;"
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE radcheck TO radius;"
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE radpostauth TO radius;"
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE radreply TO radius;"
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE radusergroup TO radius;"
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE radgroupcheck TO radius;"
sudo -u postgres psql -d radius -c "GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE radgroupreply TO radius;"
sudo -u postgres psql -d radius -c "GRANT USAGE, SELECT ON SEQUENCE radpostauth_id_seq TO radius;"
```

- SQL Data 입력

```bash
sudo -u postgres psql -d radius -c "INSERT INTO radcheck (username, attribute, op, value) VALUES ('bob', 'Cleartext-Password', ':=', 'qwer1234');"
sudo -u postgres psql -d radius -c "INSERT INTO radusergroup (username, groupname, priority) VALUES ('bob', 'RadiusUsers', 1);"
```

- SQL radcheck Tables Data 조회

```bash
sudo -u postgres psql -d radius -c "SELECT * FROM radcheck;"
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }
  
```bash
 id | username |     attribute      | op |  value   
----+----------+--------------------+----+----------
  1 | bob      | Cleartext-Password | := | qwer1234
  2 | alice    | Cleartext-Password | := | qwer1234
(2 rows)
```

</details>

- SQL radusergroup Tables Data 조회

```bash
sudo -u postgres psql -d radius -c "SELECT * FROM radusergroup;"
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }
  
```bash
 id | username |  groupname  | priority 
----+----------+-------------+----------
  1 | bob      | RadiusUsers |        1
  2 | alice    | RadiusUsers |        1
(2 rows)
```

</details>

#### FreeRADIUS 설정

- RADIUS 서버 인증 시도 로그 기록 설정

```bash
sed -i '349s/auth = no/auth = yes/' /etc/freeradius/3.0/radiusd.conf
sed -i '373s/auth_badpass = no/auth_badpass = yes/' /etc/freeradius/3.0/radiusd.conf
sed -i '374s/auth_goodpass = no/auth_goodpass = yes/' /etc/freeradius/3.0/radiusd.conf
sed -n '349p' /etc/freeradius/3.0/radiusd.conf
sed -n '373p' /etc/freeradius/3.0/radiusd.conf
sed -n '374p' /etc/freeradius/3.0/radiusd.conf
```

- sql, pam 심볼릭 링크 파일 생성

```bash
cd /etc/freeradius/3.0/mods-enabled
ln -s ../mods-available/sql sql
ln -s ../mods-available/pam pam
chown -h $(id -u freerad):$(id -g freerad) sql pam
```

- PostgreSQL DB 설정

```bash
sed -i -e 's/dialect = "sqlite"/dialect = "postgresql"/' \
       -e 's/driver = "rlm_sql_null"/#&/' \
       -e '/driver = "rlm_sql_${dialect}"/ s/^#//' \
       -e '/server = "localhost"/ s/^#//' \
       -e '/port = 3306/ s/^#//' \
       -e 's/port = 3306/port = 5432/' \
       -e '/login = "radius"/ s/^#//' \
       -e '/read_clients = yes/ s/^#//' \
       -e '/password = "radpass"/ s/^#//' \
       -e 's/password = "radpass"/password = "qwer1234"/' /etc/freeradius/3.0//mods-available/sql
```

- Google 2FA 등록 설정

```bash
sed -i '/pam/ s/^#//' /etc/freeradius/3.0/sites-enabled/default
sed -n '553p' /etc/freeradius/3.0/sites-enabled/default
sed -i 's/@include/#@include/g' /etc/pam.d/radiusd

echo "
# Google Authenticator 모듈을 사용한 OTP 인증
auth       required     pam_google_authenticator.so forward_pass secret=/etc/freeradius/3.0/pam.d/\${USER}/.google_authenticator user=freerad
# 시스템 사용자 계정 인증
account    required    pam_permit.so use_first_pass\
" >> /etc/pam.d/radiusd

cat /etc/pam.d/radiusd

echo "
# Instruct FreeRADIUS to use PAM to authenticate users
DEFAULT Auth-Type := PAM\
" >> /etc/freeradius/3.0/mods-config/files/authorize
sed -n '207,$p' /etc/freeradius/3.0/mods-config/files/authorize
```

- FortiGate 접속 정보 등록

```bash
echo "
client FortiGate-60E {
        ipaddr          = 10.1.0.0
        netmask         = 24
        port            = 1812
        proto           = *
        secret          = testing123
        require_message_authenticator = no
        nas_type        = other
}" >> /etc/freeradius/3.0/clients.conf
```

> - ipaddr를 지정하지 않을 경우 0.0.0.0/0 모든 IP 허용
```bash
echo "
client FortiGate-60E {
        port            = 1812
        proto           = *
        secret          = testing123
        require_message_authenticator = no
        nas_type        = other
}" >> /etc/freeradius/3.0/clients.conf
```
>
{: .important }

- *Google Authenticator 2Factor* 인증 사용시 디렉토리 권한 변경

```bash
sed -i 's/ReadOnlyDirectories=\/etc\/freeradius/#ReadOnlyDirectories=\/etc\/freeradius/' /lib/systemd/system/freeradius.service
```

- FreeRADIUS 서비스 등록 및 재시작

```bash
systemctl daemon-reload
systemctl enable --now freeradius.service
```

> - Google Authenticator 2Factor 인증키 생성 방법
```bash
google-authenticator -tdf -r 1 -Q UTF8 -R 30 -s /home/${user:-bob}/.ssh/.google_authenticator
```
>
{: .important}

- Google Authenticator 2Factor 복사

```bash
mkdir -p /etc/freeradius/3.0/pam.d/bob
cd /etc/freeradius/3.0/pam.d/bob
cp -av /home/bob/.ssh/.google_authenticator .google_authenticator
chown -R freerad:freerad /etc/freeradius/3.0/pam.d/
```

- FreeRADIUS 디버깅 활성화

```bash
freeradius -X
```

- Localhost 서버에서 RADIUS 테스트

```bash
radtest bob qwer1234 localhost 0 testing123
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }

```bash
Sent Access-Request Id 98 from 0.0.0.0:53028 to 127.0.0.1:1812 length 73
        User-Name = "bob"
        User-Password = "qwer1234557505"
        NAS-IP-Address = 10.1.1.100
        NAS-Port = 0
        Message-Authenticator = 0x00
        Cleartext-Password = "qwer1234557505"
Received Access-Accept Id 98 from 127.0.0.1:1812 to 127.0.0.1:53028 length 20
```

</details>

- Remote 서버에서 RADIUS 테스트

```bash
radtest bob qwer1234 10.1.1.100 0 testing123
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }

```bash
Sent Access-Request Id 125 from 0.0.0.0:40436 to 10.1.1.100:1812 length 73
        User-Name = "bob"
        User-Password = "qwer1234557505"
        NAS-IP-Address = 10.1.1.200
        NAS-Port = 0
        Message-Authenticator = 0x00
        Cleartext-Password = "qwer1234557505"
Received Access-Accept Id 125 from 10.1.1.100:1812 to 10.1.200.1:40436 length 20
```

</details>

- FortiGate RADIUS 서버 등록

```bash
config user radius
    edit "if-radius"
        set server "10.1.1.100"
        set secret testing123
    next
end
```

- FortiGate & Test User Credentiials

```bash
diagnose test authserver radius if-radius pap bob qwer1234
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }
  
```bash
authenticate 'bob' against 'pap' succeeded, server=primary assigned_rad_session_id=1864367789 session_timeout=0 secs idle_timeout=0 secs!
```

![image](https://github.com/heaths2/heaths2.github.io/assets/36792594/dae0174a-b88f-40a1-a633-2775250840ac)

![image](https://github.com/heaths2/heaths2.github.io/assets/36792594/335631f6-25d0-45b2-ba82-f01e82d3fc5c)

</details>
