---
layout: default
title: Keepalived 구성
parent: Blog
grand_parent: Category
permalink: docs/category/blog/b0146
child_nav_order: desc
---

# Keepalived 구성

<details open markdown="block">
  <summary>
    Table of contents
  </summary>
  {: .no_toc .text-delta .label .label-green }
1. TOC
{:toc}
</details>

---

## 개요

{: .new }
> - Keepalived 구성
> - [Keepalived Documents](https://keepalived.readthedocs.io/en/latest/configuration_synopsis.html)


### Keepalived 구성


### **로드밸런싱 알고리즘 (`lb_algo`)**

| **알고리즘** | **설명** | **사용 예시** |
|--------------|-----------|--------------|
| **rr** (Round Robin) | 요청을 순서대로 각 서버에 순차적으로 분배합니다. | 부하가 고르게 분산되며, 세션 유지는 필요 없는 서비스에 적합 |
| **wrr** (Weighted Round Robin) | 서버별 가중치에 따라 트래픽을 분배합니다. | 고성능 서버에 더 많은 트래픽을 보낼 때 유용 |
| **lc** (Least Connections) | 현재 연결 수가 가장 적은 서버로 요청을 보냅니다. | 세션을 많이 사용하는 서비스 (예: 채팅, 로그인) |
| **wlc** (Weighted Least Connections) | 가중치와 현재 연결 수를 함께 고려해 분배합니다. | 서버 자원과 트래픽을 유연하게 분산해야 할 때 |
| **sh** (Source Hash) | 클라이언트의 IP 해시를 사용해 항상 동일한 서버로 연결합니다. | 세션 유지를 필요로 하는 애플리케이션 (예: 로그인) |
| **dh** (Destination Hash) | 목적지 IP를 해시해 특정 서버에 트래픽을 분배합니다. | 네트워크 구간별로 동일 서버에 트래픽을 보내야 할 때 |
| **lblc** (Locality-Based Least Connections) | 클라이언트가 이전에 연결한 서버로 우선 연결합니다. 부하가 높으면 다른 서버로 이동합니다. | 세션 유지와 부하 분산이 동시에 필요한 서비스 |

---

### **LVS 모드 (`lb_kind`)**

| **모드** | **설명** | **장점** | **단점** | **사용 예시** |
|-----------|----------|-----------|----------|--------------|
| **NAT** (Network Address Translation) | 로드밸런서가 모든 요청과 응답을 중계합니다. | 서버가 외부에 노출되지 않음 | 로드밸런서의 부하 증가 | 소규모 트래픽 또는 보안이 중요한 환경 |
| **DR** (Direct Routing) | 요청은 로드밸런서를 거쳐 전달되고, 응답은 서버가 직접 처리합니다. | 로드밸런서의 부하 감소 | 백엔드 서버와 로드밸런서가 같은 네트워크에 있어야 함 | 고성능이 필요한 환경 |
| **TUN** (Tunneling) | 요청은 터널을 통해 원격지 서버로 전달됩니다. 서버가 직접 응답합니다. | 멀리 떨어진 서버로도 분배 가능 | 터널 설정이 복잡 | 지리적으로 분산된 서버를 사용하는 환경 |



- 설치

```bash
apt-get install -y keepalived
```

- MASTER 서버 설정

```bash
echo "\
! Configuration File for keepalived
  
global_defs {
    notification_email {
        idc@infra.com
    }

    notification_email_from no-reply@infra.com

    smtp_server 127.0.0.1           # SMTP 서버 주소
    smtp_connect_timeout 60         # SMTP 서버 연결 타임아웃

    router_id LVS_MAIN              # 라우터 ID (서버 식별용)
    
    enable_script_security          # 스크립트 보안 활성화 (권장)
}

vrrp_instance www-ha01_vrrp {
    state MASTER
    interface eth0
    virtual_router_id 100
    priority 110
    advert_int 1

    state MASTER                    # MASTER/SLAVE 중 선택 (주 서버에서는 MASTER)
    interface eth0                  # VIP를 할당할 네트워크 인터페이스
    virtual_router_id 100           # VRRP 그룹 ID (범위: 1 ~255, 같은 그룹에서는 동일해야 함)
    priority 100                    # 우선순위 (숫자가 높을수록 우선)
    advert_int 1                    # VRRP 신호 간격 (초 단위)


    authentication {
        auth_type PASS
        auth_pass 1234              # VRRP 인증 비밀번호
    }

    virtual_ipaddress {
        192.168.0.100/32            # VIP 설정
    }
}" > /etc/keepalived/keepalived.conf
```

- BACKUP 서버 설정

```bash
echo "\
! Configuration File for keepalived
  
global_defs {
    notification_email {
        idc@infra.com
    }
    notification_email_from idc@infra.com
    smtp_server 192.168.0.200
    smtp_connect_timeout 60
    router_id test-ha02
}

vrrp_instance test-ha02_vrrp {
    state BACKUP
    interface eth0
    virtual_router_id 30
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass qwer1234
    }
    virtual_ipaddress {
        192.168.0.100/32
    }
}" > /etc/keepalived/keepalived.conf
```

- Keepalived 서비스 등록 및 재시작

```bash
systemctl enable --now keepalived.service
```

- MASTER 서버 Keepalived 설정 확인

```
ip -brief address show
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }
  
```bash
lo               UNKNOWN        127.0.0.1/8 ::1/128 
eth0             UP             192.168.0.10/24 192.168.0.100/32
```

</details>

#### 네트워크 트래픽 확인

```bash
tcpdump -i eth0 vrrp
```

<details markdown="block">
  <summary>
    코드
  </summary>
  {: .text-delta .label .label-green }

```bash
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
10:09:19.556745 IP 192.168.0.10 > vrrp.mcast.net: VRRPv2, Advertisement, vrid 100, prio 110, authtype simple, intvl 1s, length 20
10:09:20.557024 IP 192.168.0.10 > vrrp.mcast.net: VRRPv2, Advertisement, vrid 100, prio 110, authtype simple, intvl 1s, length 20
10:09:21.557242 IP 192.168.0.10 > vrrp.mcast.net: VRRPv2, Advertisement, vrid 100, prio 110, authtype simple, intvl 1s, length 20
10:09:22.557494 IP 192.168.0.10 > vrrp.mcast.net: VRRPv2, Advertisement, vrid 100, prio 110, authtype simple, intvl 1s, length 20
10:09:23.557700 IP 192.168.0.10 > vrrp.mcast.net: VRRPv2, Advertisement, vrid 100, prio 110, authtype simple, intvl 1s, length 20
```

</details>
