---
layout: default
title: PXE boot Server
parent: Blog
grand_parent: Category
permalink: docs/category/blog/102
child_nav_order: desc
---
# PXE boot Server
<details open markdown="block">
  <summary>
    Table of contents
  </summary>
  {: .no_toc .text-delta }
1. TOC
{:toc}
---
## 개요

> - PXE(Pre-boot eXecution Environment) boot Server
> - [참조](https://ubuntu.com/server/docs/install/netboot-amd64)
{: .new }

### 패키지 설치
```bash
apt install -y tftp-hpa tftpd-hpa isc-dhcp-server syslinux-common pxelinux
```

### tftp 기본 설정

```bash
# /etc/default/tftpd-hpa

TFTP_USERNAME="tftp"
TFTP_DIRECTORY="/srv/tftp"
TFTP_ADDRESS=":69"
TFTP_OPTIONS="--secure"
```

### PXE 부팅을 위한 디렉토리 생성 및 다운로드

```bash
echo "https://releases.ubuntu.com/focal/ubuntu-20.04.6-live-server-amd64.iso" "https://releases.ubuntu.com/jammy/ubuntu-22.04.3-live-server-amd64.iso" "https://jaist.dl.sourceforge.net/project/clonezilla/clonezilla_live_stable/3.1.0-22/clonezilla-live-3.1.0-22-amd64.iso" | xargs -P 4 -n 1 wget --progress=bar
wait
```

### ISO 마운트 후 부팅을 위한 파일 복사

```bash
mkdir -p /srv/tftp/{clonezilla,ubuntu20.04,ubuntu22.04,windows10,pxelinux.cfg}
```

```bash
tree /srv/
```

```bash
/srv/
└── tftp
    ├── clonezilla
    ├── menu.c32
    ├── pxelinux.0
    ├── pxelinux.cfg
    │   └── default
    ├── ubuntu20.04
    │   ├── initrd
    │   ├── ubuntu-20.04.6-live-server-amd64.iso
    │   └── vmlinuz
    ├── ubuntu22.04
    │   ├── initrd
    │   ├── ubuntu-22.04.3-live-server-amd64.iso
    │   └── vmlinuz
    └── windows10
        ├── memdisk
        └── Windows10_Pro_KR.iso
```

```
mkdir -p /mnt/{ubuntu20.04,ubuntu22.04}
mount -t iso9660 -o loop,ro ~/ubuntu-20.04.6-live-server-amd64.iso /mnt/ubuntu20.04
mount -t iso9660 -o loop,ro ~/ubuntu-22.04.3-live-server-amd64.iso /mnt/ubuntu22.04
cp -a /mnt/ubuntu20.04/casper/{vmlinuz,initrd} /srv/tftp/ubuntu20.04/
cp -a /mnt/ubuntu22.04/casper/{vmlinuz,initrd} /srv/tftp/ubuntu22.04/
wait

umount /mnt/ubuntu20.04
umount /mnt/ubuntu22.04
```

### Syslinux와 PXELINUX 파일 복사

- Ubuntu20.04 & Ubuntu22.04

```bash
cp -a /usr/lib/syslinux/modules/bios/menu.c32 /srv/tftp/
cp -a /usr/lib/PXELINUX/pxelinux.0 /srv/tftp/
```

- Windows7 & Windows10

```bash
cp -a /usr/lib/syslinux/modules/bios/menu.c32 /srv/tftp/
cp -a /usr/lib/syslinux/memdisk /srv/tftp/
```

### PXELINUX 설정 파일 생성

```bash
#IPADD=$(hostname -I | tr -d ' ')
IPADD=$(hostname -I | cut -d ' ' -f 1)

tee /srv/tftp/pxelinux.cfg/default << EOF
DEFAULT install
  LABEL install
  KERNEL vmlinuz
  INITRD initrd
  APPEND root=/dev/ram0 ramdisk_size=1500000 ip=dhcp url=http://$IPADD/ubuntu-20.04.6-live-server-amd64.iso
EOF
```

```bash
tee /srv/tftp/pxelinux.cfg/default << EOF
DEFAULT menu.c32
PROMPT 0
MENU TITLE ######## PXE Boot Menu ########
TIMEOUT 90
TOTALTIMEOUT 9000
ONTIMEOUT 1

LABEL 0
  MENU LABEL ^0) Local Boot
  LOCALBOOT 0

LABEL 1
  MENU LABEL ^1) Install Ubuntu 20.04
  KERNEL vmlinuz
  INITRD initrd
  APPEND root=/dev/ram0 ramdisk_size=1500000 ip=dhcp url=http://192.168.0.40/ubuntu20.04/ubuntu-20.04.6-live-server-amd64.iso

LABEL 2
  MENU LABEL ^2) Install Ubuntu 22.04
  KERNEL vmlinuz
  INITRD initrd
  APPEND root=/dev/ram0 ramdisk_size=1500000 ip=dhcp url=http://192.168.0.40/ubuntu22.04/ubuntu-22.04.3-live-server-amd64.iso

LABEL 3
  MENU LABEL ^3) Install Windows10
  KERNEL memdisk
  INITRD initrd
  APPEND root=/dev/ram0 ramdisk_size=1500000 ip=dhcp url=http://192.168.0.40/windows10/Windows10_Pro_KR.iso
EOF
```

### DHCP 서버 설정 업데이트

```bash
IPADD=$(hostname -I | awk '{print $1}')
IPGW=$(ip route | grep default | head -n 1 | awk '{print $3}')
IPADD_PREFIX=$(echo $IPADD | sed 's/\.[0-9]*$//')
cat << EOF >> /etc/dhcp/dhcpd.conf

subnet 192.168.0.0 netmask 255.255.255.0 {
 option routers                  $IPGW;
 option subnet-mask              255.255.255.0;
 option domain-name-servers      1.1.1.1, 8.8.8.8;
 #  option domain-name              "in.infra.com";
 option time-offset              32400;     # Timezone: Asia/Seoul
 range $IPADD_PREFIX.100 $IPADD_PREFIX.200;
 next-server $IPADD;
 filename "u20/pxelinux.0";
}
EOF
```

### TFTP 서버 및 DHCP 서버 재시작

```bash
systemctl restart tftpd-hpa.service
systemctl restart isc-dhcp-server
```

> **정상** 로드 중 멈춤 현상 시 아래 원인
> - 네트워크 문제
> - 서버 리소스 부족
> - 방화벽 또는 보안 설정
{: .important }


### WebServer

```bash
python3 -m http.server 80
```

- Nginx location 추가

- **[Nginx lts설치 참](https://heaths2.github.io/docs/category/blog/105)**

```bash
# Nginx 1.24 버전 기준 
mkdir -p /usr/share/nginx/html/pxe/{clonezilla,ubuntu-20.04,ubuntu-22.04,windows10}

# /etc/nginx/conf.d/default.conf
server {
    listen       80;
    server_name  localhost;

    #access_log  /var/log/nginx/host.access.log  main;

    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
    }

    location /pxe/ {
        root /usr/share/nginx/html;
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;
    }
...이하생략...
```

> - `nginx` or `apache`와 같은 Web 서버 사용 가능
{: .important }
